<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ—å•†ç†±éŸ³ç¤¾ - ç·´åœ˜å®¤é ç´„ç³»çµ±</title>
    <!-- ç§»é™¤ EmailJS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ä¿æŒæ‰€æœ‰ CSS æ¨£å¼ä¸è®Š */
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --primary-light: #dbeafe;
            --secondary: #f0f9ff;
            --accent: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --text-dark: #1e293b;
            --text-light: #64748b;
            --text-white: #ffffff;
            --gray-light: #f1f5f9;
            --gray: #e2e8f0;
            --gray-dark: #94a3b8;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --radius: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background: var(--secondary);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* å°èˆªæ¬„ */
        .navbar {
            background: white;
            border-bottom: 1px solid var(--gray);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .nav-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .nav-menu {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .nav-item {
            color: var(--text-dark);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: var(--radius);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-item:hover {
            background: var(--primary-light);
            color: var(--primary-dark);
        }

        .nav-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--primary);
            cursor: pointer;
            padding: 0.5rem;
        }

        .hidden {
            display: none !important;
        }

        /* ä¸»è¦å…§å®¹ */
        .main-content {
            flex: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            width: 100%;
        }

        .card {
            background: white;
            border-radius: var(--radius);
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--primary-light);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* æŒ‰éˆ• */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--gray-light);
            color: var(--text-dark);
        }

        .btn-secondary:hover {
            background: var(--gray);
        }

        .btn-success {
            background: var(--accent);
            color: white;
        }

        .btn-danger {
            background: var(--error);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* æ™‚é–“è»¸æ—¥æ›†æ¨£å¼ */
        .timeline-calendar {
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            background: var(--primary);
            color: white;
        }

        .calendar-nav {
            display: flex;
            gap: 0.5rem;
        }

        .timeline-container {
            display: flex;
            min-height: 600px;
        }

        .time-column {
            width: 80px;
            background: var(--gray-light);
            border-right: 1px solid var(--gray);
        }

        .time-slot-header {
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            color: var(--text-dark);
            border-bottom: 1px solid var(--gray);
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .days-container {
            flex: 1;
            display: flex;
        }

        .day-column {
            flex: 1;
            border-right: 1px solid var(--gray);
        }

        .day-column:last-child {
            border-right: none;
        }

        .day-header {
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            background: var(--primary-light);
            color: var(--primary-dark);
            border-bottom: 1px solid var(--gray);
            height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .day-name {
            font-size: 0.9rem;
            font-weight: 700;
        }

        .day-date {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        /* å„ªåŒ–æ™‚é–“æ ¼å­æ¨£å¼ */
        .time-slot {
            height: 60px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            padding: 4px;
            font-size: 0.8rem;
            text-align: center;
            transition: all 0.2s ease;
        }

        /* å„ªåŒ–é ç´„è³‡è¨Šé¡¯ç¤º */
        .booking-info {
            font-size: 0.7rem;
            text-align: center;
            padding: 2px;
            width: 100%;
            overflow: hidden;
        }

        .booking-name {
            font-weight: 700;
            margin-bottom: 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.65rem;
        }

        .booking-type {
            font-size: 0.6rem;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* å„ªåŒ–ç‹€æ…‹æ–‡å­—é¡¯ç¤º */
        .status-text {
            font-size: 0.75rem;
            font-weight: 500;
            text-align: center;
        }

        /* ç¢ºä¿é ç´„è³‡è¨Šæ­£ç¢ºå±…ä¸­ */
        .booking-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            padding: 2px;
        }

        .booking-name {
            font-weight: 700;
            margin-bottom: 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.65rem;
            max-width: 100%;
            text-align: center;
        }

        .booking-type {
            font-size: 0.6rem;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            text-align: center;
        }

        /* å„ªåŒ–æ™‚é–“æ ¼å­çš„æ•´é«”ä½ˆå±€ */
        .time-slot {
            height: 60px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            padding: 2px;
            font-size: 0.8rem;
            text-align: center;
            transition: all 0.2s ease;
        }

        /* ç¢ºä¿æ‰€æœ‰å…§å®¹éƒ½æ­£ç¢ºå±…ä¸­ */
        .time-slot > * {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }

        /* å„ªåŒ–ä¸åŒç‹€æ…‹çš„è¦–è¦ºæ•ˆæœ */
        .time-slot.available {
            background: rgba(16, 185, 129, 0.05);
        }

        .time-slot.available:hover {
            background: rgba(16, 185, 129, 0.1);
        }

        .time-slot.booked {
            background: rgba(245, 158, 11, 0.1);
            cursor: not-allowed;
        }

        .time-slot.own-booking {
            background: rgba(59, 130, 246, 0.1);
        }

        .time-slot.past {
            background: rgba(100, 116, 139, 0.05);
            color: var(--text-light);
            cursor: not-allowed;
        }

        .time-slot.future-limit {
            background: rgba(100, 116, 139, 0.02);
            color: var(--text-light);
            cursor: not-allowed;
        }

        .status-pending { 
            color: var(--warning); 
            font-weight: 700;
            background: rgba(245, 158, 11, 0.1);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        .status-approved { 
            color: var(--accent); 
            font-weight: 700;
            background: rgba(16, 185, 129, 0.1);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        .status-rejected { 
            color: var(--error); 
            font-weight: 700;
            background: rgba(239, 68, 68, 0.1);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .user-item, .booking-item {
            background: white;
            border: 1px solid var(--gray);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .user-info, .booking-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .user-actions, .booking-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 1.5rem;
            border-radius: var(--radius);
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius);
            padding: 2rem;
            width: 90%;
            max-width: 500px;
        }

        .type-option {
            flex: 1;
            text-align: center;
            padding: 10px;
            border: 2px solid var(--gray);
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 500;
        }

        .type-option.selected {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary);
        }

        .message {
            padding: 12px 16px;
            margin: 1rem 0;
            border-radius: var(--radius);
            text-align: center;
            font-weight: 500;
        }

        .message.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--accent);
            color: var(--accent);
        }

        .message.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }

        .notification-badge {
            background: var(--error);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            margin-left: 5px;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--gray);
            border-radius: var(--radius);
            font-size: 1rem;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* æ‰‹æ©Ÿç‰ˆæ—¥æ›†å„ªåŒ– */
        .mobile-time-display {
            display: none;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 4px;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .nav-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 44px;
                height: 44px;
                transition: all 0.3s ease;
            }

            .nav-toggle:hover {
                background: var(--primary-light);
                border-radius: var(--radius);
            }

            .nav-menu {
                display: none;
                flex-direction: column;
                position: absolute;
                top: 100%;
                left: 0;
                width: 100%;
                background: white;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                border-top: 1px solid var(--gray);
                z-index: 1000;
                max-height: 70vh;
                overflow-y: auto;
            }

            .nav-menu.active {
                display: flex;
                animation: slideDown 0.3s ease;
            }

            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .nav-item {
                padding: 16px 2rem;
                border-bottom: 1px solid var(--gray-light);
                justify-content: flex-start;
                font-size: 1rem;
                transition: all 0.2s ease;
            }

            .nav-item:hover {
                background: var(--primary-light);
                color: var(--primary-dark);
            }

            .nav-item:last-child {
                border-bottom: none;
            }

            .main-content {
                padding: 1rem;
            }

            .card {
                padding: 1.5rem;
            }

            /* æ‰‹æ©Ÿç‰ˆæ—¥æ›†é‡æ–°è¨­è¨ˆ */
            .timeline-container {
                flex-direction: column;
                min-height: auto;
            }

            .time-column {
                display: none;
            }

            .days-container {
                flex-direction: column;
            }

            .day-column {
                margin-bottom: 1rem;
                border: 1px solid var(--gray);
                border-radius: var(--radius);
            }

            .day-header {
                background: var(--primary);
                color: white;
                border-radius: var(--radius) var(--radius) 0 0;
            }

            .time-slot {
                height: 70px;
                padding: 8px;
                border-bottom: 1px solid var(--gray-light);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: flex-start;
            }

            .mobile-time-display {
                display: block;
                font-size: 0.8rem;
                font-weight: 600;
                color: var(--text-dark);
                margin-bottom: 4px;
            }

            /* å„ªåŒ–æ‰‹æ©Ÿç‰ˆé ç´„è³‡è¨Šé¡¯ç¤º */
            .booking-info {
                width: 100%;
                padding: 4px;
                text-align: left;
            }

            .booking-name {
                font-size: 0.75rem;
                margin-bottom: 2px;
                white-space: normal;
                overflow: visible;
                text-overflow: unset;
                line-height: 1.2;
            }

            .booking-type {
                font-size: 0.7rem;
                white-space: normal;
                overflow: visible;
                text-overflow: unset;
                line-height: 1.2;
            }

            .status-text {
                font-size: 0.75rem;
                text-align: left;
                width: 100%;
            }

            .user-info, .booking-info {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .day-header,
            .time-slot-header {
                height: 45px;
            }

            /* ç¢ºä¿é€šçŸ¥å¾½ç« åœ¨æ‰‹æ©Ÿä¸Šå¯è¦‹ */
            .notification-badge {
                margin-left: 8px;
            }
        }

        /* ç•¶é¸å–®æ‰“é–‹æ™‚é˜²æ­¢èƒŒæ™¯æ»¾å‹• */
        body.menu-open {
            overflow: hidden;
        }

        /* å®‰å…¨é©—è­‰æ¨£å¼ */
        .security-check {
            margin-bottom: 1rem;
        }

        .rate-limit-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
            padding: 10px;
            border-radius: var(--radius);
            text-align: center;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- å°èˆªæ¬„ -->
        <nav class="navbar">
            <div class="nav-container">
                <div class="nav-logo">
                    <i class="fas fa-guitar"></i>
                    <span>åŒ—å•†ç†±éŸ³ç¤¾</span>
                </div>
                
                <!-- æ¼¢å ¡é¸å–®æŒ‰éˆ• -->
                <button class="nav-toggle" id="navToggle">
                    <i class="fas fa-bars"></i>
                </button>
                
                <div class="nav-menu" id="navMenu">
                    <a href="#" class="nav-item" data-view="home">é¦–é </a>
                    <a href="#" class="nav-item" data-view="login" id="loginNav">ç™»å…¥</a>
                    <a href="#" class="nav-item" data-view="signup" id="signupNav">è¨»å†Š</a>
                    <a href="#" class="nav-item hidden" data-view="profile" id="profileNav">å€‹äººè³‡æ–™</a>
                    <a href="#" class="nav-item hidden" data-view="calendar" id="calendarNav">é ç´„ç·´åœ˜</a>
                    <a href="#" class="nav-item hidden" data-view="admin" id="adminNav">
                        ç®¡ç†å¾Œå°
                        <span class="notification-badge hidden" id="adminNotification">0</span>
                    </a>
                    <a href="#" class="nav-item hidden" id="logoutNav">ç™»å‡º</a>
                </div>
            </div>
        </nav>

        <!-- ä¸»è¦å…§å®¹ -->
        <main class="main-content">
            <!-- è¨Šæ¯é¡¯ç¤º -->
            <div id="messageContainer"></div>

            <!-- é¦–é å…§å®¹ -->
            <section class="card" id="homeSection">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-home"></i> æ­¡è¿ä½¿ç”¨ç·´åœ˜å®¤é ç´„ç³»çµ±</h2>
                </div>
                <p>è«‹å…ˆè¨»å†Šå¸³è™Ÿä¸¦å¡«å¯«å€‹äººè³‡æ–™ï¼Œç¶“ç®¡ç†å“¡å¯©æ ¸å¾Œå³å¯é ç´„ç·´åœ˜æ™‚é–“ã€‚</p>
                
                <div class="stats-grid" style="margin-top: 2rem;">
                    <div class="stat-card">
                        <div class="stat-number" id="homeTotalUsers">0</div>
                        <div class="stat-label">ç¸½ç”¨æˆ¶æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="homeTotalBookings">0</div>
                        <div class="stat-label">ç¸½é ç´„æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="homeTodayBookings">0</div>
                        <div class="stat-label">ä»Šæ—¥é ç´„</div>
                    </div>
                </div>
            </section>

            <!-- ç™»å…¥è¡¨å–® -->
            <section class="card hidden" id="loginSection">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-sign-in-alt"></i> ç™»å…¥å¸³è™Ÿ</h2>
                </div>
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">é›»å­éƒµä»¶</label>
                        <input type="email" class="form-control" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å¯†ç¢¼</label>
                        <input type="password" class="form-control" id="loginPassword" required>
                    </div>
                    <div class="security-check">
                        <div class="form-group">
                            <label class="form-label">å®‰å…¨é©—è­‰</label>
                            <div id="securityQuestion" style="margin-bottom: 0.5rem; font-weight: 600;"></div>
                            <input type="text" class="form-control" id="securityAnswer" placeholder="è«‹è¼¸å…¥è¨ˆç®—çµæœ" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">ç™»å…¥</button>
                </form>
                <p style="margin-top: 1rem; text-align: center;">
                    é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ <a href="#" data-view="signup" style="color: var(--primary);">ç«‹å³è¨»å†Š</a>
                </p>
            </section>

            <!-- è¨»å†Šè¡¨å–® -->
            <section class="card hidden" id="signupSection">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-user-plus"></i> è¨»å†Šæ–°å¸³è™Ÿ</h2>
                </div>
                <form id="signupForm">
                    <div class="form-group">
                        <label class="form-label">é›»å­éƒµä»¶</label>
                        <input type="email" class="form-control" id="signupEmail" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å¯†ç¢¼</label>
                        <input type="password" class="form-control" id="signupPassword" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç¢ºèªå¯†ç¢¼</label>
                        <input type="password" class="form-control" id="signupConfirmPassword" required>
                    </div>
                    <div class="security-check">
                        <div class="form-group">
                            <label class="form-label">å®‰å…¨é©—è­‰</label>
                            <div id="signupSecurityQuestion" style="margin-bottom: 0.5rem; font-weight: 600;"></div>
                            <input type="text" class="form-control" id="signupSecurityAnswer" placeholder="è«‹è¼¸å…¥è¨ˆç®—çµæœ" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">è¨»å†Š</button>
                </form>
                <p style="margin-top: 1rem; text-align: center;">
                    å·²ç¶“æœ‰å¸³è™Ÿï¼Ÿ <a href="#" data-view="login" style="color: var(--primary);">ç«‹å³ç™»å…¥</a>
                </p>
            </section>

            <!-- å€‹äººè³‡æ–™è¡¨å–® -->
            <section class="card hidden" id="profileSection">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-user"></i> å€‹äººè³‡æ–™</h2>
                </div>
                <form id="profileForm">
                    <div class="form-group">
                        <label class="form-label">çœŸå¯¦å§“å</label>
                        <input type="text" class="form-control" id="realName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å­¸è™Ÿ</label>
                        <input type="text" class="form-control" id="studentId" required pattern="[0-9]{8}" title="è«‹è¼¸å…¥8ä½æ•¸å­—å­¸è™Ÿ">
                    </div>
                    <div class="form-group">
                        <label class="form-label">è¯çµ¡é›»è©±</label>
                        <input type="tel" class="form-control" id="phone" required pattern="[0-9]{10}" title="è«‹è¼¸å…¥10ä½æ•¸å­—é›»è©±è™Ÿç¢¼">
                    </div>
                    <button type="submit" class="btn btn-primary">æäº¤è³‡æ–™ç­‰å¾…å¯©æ ¸</button>
                </form>
            </section>

            <!-- æ™‚é–“è»¸æ—¥æ›† -->
            <section class="card hidden" id="calendarSection">
                <div class="timeline-calendar">
                    <div class="calendar-header">
                        <h2 id="currentWeekDisplay">2024å¹´11æœˆ ç¬¬1é€±</h2>
                        <div class="calendar-nav">
                            <button id="prevWeek" class="btn btn-secondary"><i class="fas fa-chevron-left"></i></button>
                            <button id="todayBtn" class="btn btn-secondary">ä»Šå¤©</button>
                            <button id="nextWeek" class="btn btn-secondary"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    
                    <div class="timeline-container" id="timelineContainer">
                        <!-- æ™‚é–“è»¸å…§å®¹ç”± JavaScript ç”Ÿæˆ -->
                    </div>
                </div>
            </section>

            <!-- ç®¡ç†å“¡å¾Œå° -->
            <section class="card hidden" id="adminSection">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-cog"></i> ç®¡ç†å“¡å¾Œå°</h2>
                </div>
                
                <!-- çµ±è¨ˆè³‡æ–™ -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalUsers">0</div>
                        <div class="stat-label">ç¸½ç”¨æˆ¶æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pendingUsers">0</div>
                        <div class="stat-label">å¾…å¯©æ ¸ç”¨æˆ¶</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalBookings">0</div>
                        <div class="stat-label">ç¸½é ç´„æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="todayBookings">0</div>
                        <div class="stat-label">ä»Šæ—¥é ç´„</div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 1rem;">å¾…å¯©æ ¸ç”¨æˆ¶ <span class="notification-badge" id="pendingCount">0</span></h3>
                    <div id="pendingUsersList">
                        <!-- å¾…å¯©æ ¸ç”¨æˆ¶åˆ—è¡¨ -->
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 1rem;">ä»Šæ—¥é ç´„ç‹€æ³</h3>
                    <div id="todayBookingsList">
                        <!-- ä»Šæ—¥é ç´„åˆ—è¡¨ -->
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 1rem;">æ‰€æœ‰é ç´„è¨˜éŒ„</h3>
                    <div id="allBookingsList">
                        <!-- æ‰€æœ‰é ç´„è¨˜éŒ„ -->
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 1rem;">æ‰€æœ‰ç”¨æˆ¶</h3>
                    <div id="allUsersList">
                        <!-- æ‰€æœ‰ç”¨æˆ¶åˆ—è¡¨ -->
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- é ç´„æ¨¡æ…‹æ¡† -->
    <div class="modal" id="bookingModal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3>é ç´„ç·´åœ˜æ™‚é–“</h3>
                <button class="btn btn-secondary" id="closeModal">&times;</button>
            </div>
            <div id="bookingDetails"></div>
            <div style="display: flex; gap: 10px; margin-bottom: 1rem;">
                <div class="type-option selected" data-type="fixed">å›ºå®šç·´åœ˜</div>
                <div class="type-option" data-type="personal">å€‹äººç·´ç¿’</div>
                <div class="type-option" data-type="free">è‡ªç”±ç·´åœ˜</div>
            </div>
            <div class="form-group">
                <label class="form-label">åç¨±/åœ˜å</label>
                <input type="text" class="form-control" id="bookingName" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“åæˆ–åœ˜å">
            </div>
            <div class="form-group">
                <label class="form-label">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
                <textarea class="form-control" id="bookingNotes" rows="3" placeholder="å¦‚æœ‰ç‰¹æ®Šéœ€æ±‚è«‹åœ¨æ­¤å¡«å¯«"></textarea>
            </div>
            <button id="confirmBooking" class="btn btn-primary" style="width: 100%;">ç¢ºèªé ç´„</button>
        </div>
    </div>

    <!-- æ·»åŠ  Supabase å®¢æˆ¶ç«¯ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // Supabase é…ç½®
        const SUPABASE_URL = 'https://mpnntoqgzvfpxbvkdseq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1wbm50b3FnenZmcHhidmtkc2VxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMjc5NzgsImV4cCI6MjA3ODgwMzk3OH0.XGGT6Hf8klN54uWJlBbn2_zydSoB3s4O92S-OdA9tX4';

        // Gmail SMTP æœå‹™
        // Gmail SMTP æœå‹™
class GmailSMTPService {
    constructor() {
        // ä½¿ç”¨å®Œæ•´çš„å¾Œç«¯ URL
        this.apiEndpoint = 'https://ample-unity-production.up.railway.app/api/send-email';
        // æˆ–è€…å¦‚æœæ‚¨æœ‰éƒ¨ç½²å¾Œç«¯ï¼Œä½¿ç”¨å¯¦éš›çš„å¾Œç«¯ç¶²å€
        // å¦‚æœé‚„åœ¨æœ¬åœ°é–‹ç™¼ï¼Œæ‰‹æ©Ÿç„¡æ³•è¨ªå• localhost
    }

    async sendEmail(emailData) {
        try {
            console.log('ğŸ“§ ç™¼é€éƒµä»¶:', emailData);
            
            const response = await fetch(this.apiEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(emailData)
            });

            if (!response.ok) {
                throw new Error('éƒµä»¶ç™¼é€å¤±æ•—');
            }

            const result = await response.json();
            console.log('âœ… éƒµä»¶ç™¼é€æˆåŠŸ:', result);
            return true;
            
        } catch (error) {
            console.error('âŒ éƒµä»¶ç™¼é€å¤±æ•—:', error);
            return false;
        }
    }

    // ç™¼é€ç®¡ç†å“¡é€šçŸ¥
    async sendAdminNotification(type, data) {
        let emailData = {
            to: '11056046@ntub.edu.tw',
            type: 'admin',
            notification_type: type,
            timestamp: new Date().toLocaleString('zh-TW'),
            system_url: window.location.origin
        };

        switch(type) {
            case 'user_registration':
                emailData.subject = `ã€æ–°ç”¨æˆ¶è¨»å†Šã€‘${data.realName} å·²å®Œæˆè¨»å†Š`;
                emailData.data = {
                    real_name: data.realName,
                    user_email: data.email,
                    student_id: data.studentId,
                    phone: data.phone
                };
                break;
                
            case 'new_booking':
                emailData.subject = `ã€æ–°é ç´„é€šçŸ¥ã€‘${data.realName} é ç´„äº†ç·´åœ˜å®¤`;
                emailData.data = {
                    real_name: data.realName,
                    user_email: data.email,
                    booking_date: data.bookingDate,
                    booking_time: data.bookingTime,
                    booking_type: data.bookingType,
                    booking_name: data.bookingName,
                    booking_notes: data.bookingNotes || 'ç„¡'
                };
                break;
        }

        return await this.sendEmail(emailData);
    }

    // ç™¼é€ç”¨æˆ¶é€šçŸ¥
    async sendUserNotification(type, data) {
        let emailData = {
            to: data.userEmail,
            type: 'user',
            notification_type: type,
            timestamp: new Date().toLocaleString('zh-TW'),
            system_url: window.location.origin
        };

        switch(type) {
            case 'approval_result':
                emailData.subject = `ã€å¸³è™Ÿå¯©æ ¸é€šçŸ¥ã€‘${data.realName} - åŒ—å•†ç†±éŸ³ç¤¾`;
                emailData.data = {
                    real_name: data.realName,
                    student_id: data.studentId,
                    approval_status: data.status,
                    admin_notes: data.notes || ''
                };
                break;
                
            case 'booking_confirmation':
                emailData.subject = `ã€é ç´„æˆåŠŸã€‘${data.bookingDate} ${data.bookingTime} - ${data.bookingName}`;
                emailData.data = {
                    real_name: data.realName,
                    booking_date: data.bookingDate,
                    booking_time: data.bookingTime,
                    booking_type: data.bookingType,
                    booking_name: data.bookingName,
                    booking_notes: data.bookingNotes || 'ç„¡',
                    booking_id: data.bookingId || 'ç³»çµ±ç”Ÿæˆä¸­'
                };
                break;
        }

        return await this.sendEmail(emailData);
    }
}

        // é›²ç«¯è³‡æ–™å„²å­˜ï¼ˆä½¿ç”¨ Supabaseï¼‰
        class SupabaseService {
            constructor() {
                this.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                this.rateLimit = new Map();
            }

            checkRateLimit(identifier, limit = 5, windowMs = 60000) {
                const now = Date.now();
                const key = `${identifier}_${Math.floor(now / windowMs)}`;
                
                if (!this.rateLimit.has(key)) {
                    this.rateLimit.set(key, 0);
                }
                
                const current = this.rateLimit.get(key);
                if (current >= limit) {
                    return false;
                }
                
                this.rateLimit.set(key, current + 1);
                
                setTimeout(() => {
                    this.rateLimit.delete(key);
                }, windowMs);
                
                return true;
            }

            async login(email, password) {
                if (!this.checkRateLimit(`login_${email}`, 5, 60000)) {
                    throw new Error('å˜—è©¦æ¬¡æ•¸éå¤šï¼Œè«‹ç¨å¾Œå†è©¦');
                }

                try {
                    const { data, error } = await this.supabase
                        .from('users')
                        .select('*')
                        .eq('email', email)
                        .eq('password', password)
                        .single();
                    
                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Login error:', error);
                    throw new Error('é›»å­éƒµä»¶æˆ–å¯†ç¢¼éŒ¯èª¤');
                }
            }

            async signup(userData) {
    if (!this.checkRateLimit(`signup_${userData.email}`, 3, 60000)) {
        throw new Error('è¨»å†Šå˜—è©¦æ¬¡æ•¸éå¤šï¼Œè«‹ç¨å¾Œå†è©¦');
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(userData.email)) {
        throw new Error('è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶åœ°å€');
    }

    if (userData.password.length < 6) {
        throw new Error('å¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦6å€‹å­—ç¬¦');
    }

    try {
        // ä¿®æ­£æŸ¥è©¢èªæ³•
        const { data: existingUser, error: queryError } = await this.supabase
            .from('users')
            .select('email')
            .eq('email', userData.email);

        if (queryError) {
            console.error('æŸ¥è©¢ç”¨æˆ¶éŒ¯èª¤:', queryError);
            throw new Error('è³‡æ–™åº«æŸ¥è©¢å¤±æ•—');
        }

        if (existingUser && existingUser.length > 0) {
            throw new Error('è©²é›»å­éƒµä»¶å·²è¢«è¨»å†Š');
        }

        const { data, error } = await this.supabase
            .from('users')
            .insert([{
                email: userData.email,
                password: userData.password,
                real_name: userData.realName || '',
                student_id: userData.studentId || '',
                phone: userData.phone || '',
                status: 'pending',
                avatar: 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&q=80',
                is_admin: false,
                created_at: new Date().toISOString()
            }])
            .select()
            .single();
        
        if (error) throw error;
        return data;
    } catch (error) {
        console.error('Signup error:', error);
        throw error;
    }
}

async updateUser(email, userData) {
    try {
        const { data, error } = await this.supabase
            .from('users')
            .update({
                real_name: userData.realName,
                student_id: userData.studentId,
                phone: userData.phone,
                status: 'pending',
                updated_at: new Date().toISOString()  // æ·»åŠ æ›´æ–°æ™‚é–“
            })
            .eq('email', email)
            .select()
            .single();
        
        if (error) {
            console.error('æ›´æ–°ç”¨æˆ¶éŒ¯èª¤:', error);
            throw error;
        }
        return data;
    } catch (error) {
        console.error('Update user error:', error);
        throw error;
    }
}
            async updateUser(email, userData) {
                try {
                    const { data, error } = await this.supabase
                        .from('users')
                        .update({
                            real_name: userData.realName,
                            student_id: userData.studentId,
                            phone: userData.phone,
                            status: 'pending'
                        })
                        .eq('email', email)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Update user error:', error);
                    throw error;
                }
            }

            async createBooking(bookingData) {
                try {
                    const { data: existingBooking } = await this.supabase
                        .from('bookings')
                        .select('*')
                        .eq('date', bookingData.date)
                        .eq('time', bookingData.time)
                        .eq('status', 'confirmed')
                        .single();

                    if (existingBooking) {
                        throw new Error('è©²æ™‚æ®µå·²è¢«é ç´„');
                    }

                    const { data, error } = await this.supabase
                        .from('bookings')
                        .insert([{
                            user_email: bookingData.email,
                            real_name: bookingData.realName,
                            date: bookingData.date,
                            time: bookingData.time,
                            type: bookingData.type,
                            name: bookingData.name,
                            notes: bookingData.notes,
                            status: 'confirmed',
                            created_at: new Date().toISOString()
                        }])
                        .select()
                        .single();
                    
                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Create booking error:', error);
                    throw error;
                }
            }

            async getAllBookings() {
                try {
                    const { data, error } = await this.supabase
                        .from('bookings')
                        .select('*')
                        .order('date', { ascending: true })
                        .order('time', { ascending: true });
                    
                    if (error) throw error;
                    return data || [];
                } catch (error) {
                    console.error('Get bookings error:', error);
                    return [];
                }
            }

            async getBookingForTimeSlot(date, time) {
                try {
                    const { data, error } = await this.supabase
                        .from('bookings')
                        .select('*')
                        .eq('date', date)
                        .eq('time', time)
                        .eq('status', 'confirmed')
                        .single();
                    
                    if (error && error.code !== 'PGRST116') throw error;
                    return data || null;
                } catch (error) {
                    console.error('Get booking error:', error);
                    return null;
                }
            }

            async cancelBooking(bookingId) {
                try {
                    const { data, error } = await this.supabase
                        .from('bookings')
                        .update({ status: 'cancelled' })
                        .eq('id', bookingId)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Cancel booking error:', error);
                    throw error;
                }
            }

            async getAllUsers() {
                try {
                    const { data, error } = await this.supabase
                        .from('users')
                        .select('*');
                    
                    if (error) throw error;
                    return data || [];
                } catch (error) {
                    console.error('Get users error:', error);
                    return [];
                }
            }

            async getPendingUsers() {
                try {
                    const { data, error } = await this.supabase
                        .from('users')
                        .select('*')
                        .eq('status', 'pending');
                    
                    if (error) throw error;
                    return data || [];
                } catch (error) {
                    console.error('Get pending users error:', error);
                    return [];
                }
            }

            async approveUser(email) {
                try {
                    const { data, error } = await this.supabase
                        .from('users')
                        .update({ status: 'approved' })
                        .eq('email', email)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Approve user error:', error);
                    throw error;
                }
            }

            async rejectUser(email) {
                try {
                    const { data, error } = await this.supabase
                        .from('users')
                        .update({ status: 'rejected' })
                        .eq('email', email)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Reject user error:', error);
                    throw error;
                }
            }

            async deleteUser(email) {
                try {
                    const { error: bookingsError } = await this.supabase
                        .from('bookings')
                        .delete()
                        .eq('user_email', email);

                    if (bookingsError) throw bookingsError;

                    const { data, error } = await this.supabase
                        .from('users')
                        .delete()
                        .eq('email', email)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Delete user error:', error);
                    throw error;
                }
            }

            isAdmin(user) {
                return user && (user.is_admin === true || user.is_admin === 'true' || user.email === '11056046@ntub.edu.tw');
            }
        }

        const supabaseService = new SupabaseService();
        const emailService = new GmailSMTPService();

        class BandRoomApp {
            constructor() {
                this.currentUser = null;
                this.currentDate = new Date();
                this.selectedDate = null;
                this.selectedTime = null;
                this.selectedType = 'fixed';
                this.cloudStorage = supabaseService;
                this.currentView = 'home';
                this.currentWeekStart = new Date(this.getWeekStartDate(new Date()));
                this.bookingsCache = {};
                this.securityQuestions = {};
                
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.checkLoginStatus();
                this.showView('home');
                this.loadHomeStats();
                this.generateSecurityQuestions();
            }

            getWeekStartDate(date) {
                const newDate = new Date(date);
                const day = newDate.getDay();
                const diff = newDate.getDate() - day + (day === 0 ? -6 : 1);
                newDate.setDate(diff);
                newDate.setHours(0, 0, 0, 0);
                return newDate;
            }

            generateSecurityQuestions() {
                const num1 = Math.floor(Math.random() * 10) + 1;
                const num2 = Math.floor(Math.random() * 10) + 1;
                const answer = num1 + num2;
                
                this.securityQuestions = {
                    login: { question: `${num1} + ${num2} = ?`, answer: answer },
                    signup: { question: `${num1} + ${num2} = ?`, answer: answer }
                };
                
                const loginQuestion = document.getElementById('securityQuestion');
                const signupQuestion = document.getElementById('signupSecurityQuestion');
                
                if (loginQuestion) loginQuestion.textContent = this.securityQuestions.login.question;
                if (signupQuestion) signupQuestion.textContent = this.securityQuestions.signup.question;
            }

            validateSecurityAnswer(type, userAnswer) {
                const question = this.securityQuestions[type];
                if (!question) return false;
                return parseInt(userAnswer) === question.answer;
            }

            setupEventListeners() {
                document.getElementById('navToggle')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    const navMenu = document.getElementById('navMenu');
                    navMenu.classList.toggle('active');
                    document.body.classList.toggle('menu-open');
                });

                document.addEventListener('click', (e) => {
                    const navMenu = document.getElementById('navMenu');
                    const navToggle = document.getElementById('navToggle');
                    
                    if (navMenu && navToggle && !navToggle.contains(e.target) && !navMenu.contains(e.target)) {
                        navMenu.classList.remove('active');
                        document.body.classList.remove('menu-open');
                    }
                });

                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const navMenu = document.getElementById('navMenu');
                        if (window.innerWidth <= 768) {
                            navMenu.classList.remove('active');
                            document.body.classList.remove('menu-open');
                        }
                    });
                });

                document.addEventListener('click', (e) => {
                    if (e.target.matches('[data-view]')) {
                        e.preventDefault();
                        this.showView(e.target.getAttribute('data-view'));
                    }
                });

                document.getElementById('loginForm')?.addEventListener('submit', (e) => this.handleLogin(e));
                document.getElementById('signupForm')?.addEventListener('submit', (e) => this.handleSignup(e));
                document.getElementById('profileForm')?.addEventListener('submit', (e) => this.handleProfileUpdate(e));
                document.getElementById('logoutNav')?.addEventListener('click', (e) => this.handleLogout(e));

                document.getElementById('prevWeek')?.addEventListener('click', () => this.changeWeek(-1));
                document.getElementById('nextWeek')?.addEventListener('click', () => this.changeWeek(1));
                document.getElementById('todayBtn')?.addEventListener('click', () => this.goToToday());

                document.getElementById('closeModal')?.addEventListener('click', () => this.closeModal());
                document.getElementById('confirmBooking')?.addEventListener('click', () => this.confirmBooking());

                document.querySelectorAll('.type-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        document.querySelectorAll('.type-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        e.target.classList.add('selected');
                        this.selectedType = e.target.getAttribute('data-type');
                    });
                });
            }

            showView(viewName) {
                this.currentView = viewName;
                
                document.querySelectorAll('section.card').forEach(section => {
                    section.classList.add('hidden');
                });
                
                const targetSection = document.getElementById(viewName + 'Section');
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                }
                
                if (viewName === 'login' || viewName === 'signup') {
                    this.generateSecurityQuestions();
                }
                
                switch(viewName) {
                    case 'calendar':
                        this.renderTimelineCalendar();
                        break;
                    case 'admin':
                        if (this.currentUser && this.cloudStorage.isAdmin(this.currentUser)) {
                            this.renderAdminPanel();
                        } else {
                            this.showView('home');
                            this.showMessage('æ‚¨æ²’æœ‰ç®¡ç†å“¡æ¬Šé™', 'error');
                        }
                        break;
                    case 'profile':
                        this.loadProfileData();
                        break;
                }
            }

            showMessage(message, type) {
                const messageContainer = document.getElementById('messageContainer');
                const messageEl = document.createElement('div');
                messageEl.className = `message ${type}`;
                messageEl.textContent = message;
                messageContainer.appendChild(messageEl);
                
                setTimeout(() => {
                    messageEl.remove();
                }, 3000);
            }

            checkLoginStatus() {
                const savedUser = localStorage.getItem('ntub_currentUser');
                if (savedUser) {
                    this.currentUser = JSON.parse(savedUser);
                    this.updateNavForLoggedInUser();
                }
            }

            updateNavForLoggedInUser() {
                document.getElementById('loginNav').classList.add('hidden');
                document.getElementById('signupNav').classList.add('hidden');
                document.getElementById('profileNav').classList.remove('hidden');
                document.getElementById('calendarNav').classList.remove('hidden');
                document.getElementById('logoutNav').classList.remove('hidden');
                
                if (this.currentUser && this.cloudStorage.isAdmin(this.currentUser)) {
                    document.getElementById('adminNav').classList.remove('hidden');
                }
            }
            
            async handleSignup(e) {
                e.preventDefault();
                const email = document.getElementById('signupEmail').value;
                const password = document.getElementById('signupPassword').value;
                const confirmPassword = document.getElementById('signupConfirmPassword').value;
                const securityAnswer = document.getElementById('signupSecurityAnswer').value;
                
                if (!this.validateSecurityAnswer('signup', securityAnswer)) {
                    this.showMessage('å®‰å…¨é©—è­‰ç­”æ¡ˆéŒ¯èª¤', 'error');
                    this.generateSecurityQuestions();
                    return;
                }

                if (password !== confirmPassword) {
                    this.showMessage('å¯†ç¢¼ç¢ºèªä¸ä¸€è‡´', 'error');
                    return;
                }

                try {
                    const newUser = await this.cloudStorage.signup({
                        email: email,
                        password: password,
                        realName: '',
                        studentId: '',
                        phone: ''
                    });

                    this.currentUser = {
                        email: newUser.email,
                        password: newUser.password,
                        realName: newUser.real_name,
                        studentId: newUser.student_id,
                        phone: newUser.phone,
                        status: newUser.status,
                        avatar: newUser.avatar,
                        isAdmin: newUser.is_admin,
                        createdAt: newUser.created_at
                    };
                    
                    localStorage.setItem('ntub_currentUser', JSON.stringify(this.currentUser));
                    this.updateNavForLoggedInUser();
                    this.showMessage('è¨»å†ŠæˆåŠŸï¼è«‹å¡«å¯«å€‹äººè³‡æ–™', 'success');
                    this.showView('profile');
                    
                } catch (error) {
                    this.showMessage(error.message, 'error');
                }
            }

            async handleLogin(e) {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                const securityAnswer = document.getElementById('securityAnswer').value;

                if (!this.validateSecurityAnswer('login', securityAnswer)) {
                    this.showMessage('å®‰å…¨é©—è­‰ç­”æ¡ˆéŒ¯èª¤', 'error');
                    this.generateSecurityQuestions();
                    return;
                }

                try {
                    const user = await this.cloudStorage.login(email, password);
                    
                    if (user) {
                        this.currentUser = {
                            email: user.email,
                            password: user.password,
                            realName: user.real_name,
                            studentId: user.student_id,
                            phone: user.phone,
                            status: user.status,
                            avatar: user.avatar,
                            isAdmin: user.is_admin,
                            createdAt: user.created_at
                        };
                        
                        localStorage.setItem('ntub_currentUser', JSON.stringify(this.currentUser));
                        this.updateNavForLoggedInUser();
                        this.showMessage('ç™»å…¥æˆåŠŸï¼', 'success');
                        
                        if (user.status === 'approved') {
                            this.showView('calendar');
                        } else {
                            this.showView('profile');
                        }
                    }
                } catch (error) {
                    this.showMessage(error.message, 'error');
                    this.generateSecurityQuestions();
                }
            }

            async handleProfileUpdate(e) {
    e.preventDefault();
    const realName = document.getElementById('realName').value;
    const studentId = document.getElementById('studentId').value;
    const phone = document.getElementById('phone').value;

    try {
        const updatedUser = await this.cloudStorage.updateUser(this.currentUser.email, {
            realName: realName,
            studentId: studentId,
            phone: phone
        });

        this.currentUser.realName = updatedUser.real_name;
        this.currentUser.studentId = updatedUser.student_id;
        this.currentUser.phone = updatedUser.phone;
        this.currentUser.status = updatedUser.status;

        console.log('ğŸ”„ æº–å‚™ç™¼é€ç”¨æˆ¶è¨»å†Šé€šçŸ¥...');

        // ç™¼é€ç”¨æˆ¶è¨»å†Šé€šçŸ¥çµ¦ç®¡ç†å“¡
        const emailSent = await emailService.sendAdminNotification('user_registration', {
            realName: realName,
            email: this.currentUser.email,
            studentId: studentId,
            phone: phone
        });
        
        console.log('ğŸ“§ éƒµä»¶ç™¼é€çµæœ:', emailSent);
        
        localStorage.setItem('ntub_currentUser', JSON.stringify(this.currentUser));
        
        if (emailSent) {
            this.showMessage('å€‹äººè³‡æ–™å·²æäº¤ï¼Œç­‰å¾…ç®¡ç†å“¡å¯©æ ¸ã€‚å·²ç™¼é€é€šçŸ¥çµ¦ç®¡ç†å“¡', 'success');
        } else {
            this.showMessage('å€‹äººè³‡æ–™å·²æäº¤ï¼Œç­‰å¾…ç®¡ç†å“¡å¯©æ ¸ã€‚ä½†é€šçŸ¥ç™¼é€å¤±æ•—ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡', 'warning');
        }
        
    } catch (error) {
        console.error('âŒ è™•ç†å€‹äººè³‡æ–™æ›´æ–°éŒ¯èª¤:', error);
        this.showMessage('æ›´æ–°å¤±æ•—ï¼š' + error.message, 'error');
    }
}

            handleLogout(e) {
                e.preventDefault();
                this.currentUser = null;
                localStorage.removeItem('ntub_currentUser');
                
                document.getElementById('loginNav').classList.remove('hidden');
                document.getElementById('signupNav').classList.remove('hidden');
                document.getElementById('profileNav').classList.add('hidden');
                document.getElementById('calendarNav').classList.add('hidden');
                document.getElementById('adminNav').classList.add('hidden');
                document.getElementById('logoutNav').classList.add('hidden');
                
                this.showView('home');
                this.showMessage('å·²æˆåŠŸç™»å‡º', 'success');
            }

            loadProfileData() {
                if (this.currentUser) {
                    document.getElementById('realName').value = this.currentUser.realName || '';
                    document.getElementById('studentId').value = this.currentUser.studentId || '';
                    document.getElementById('phone').value = this.currentUser.phone || '';
                }
            }

            async loadHomeStats() {
                try {
                    const users = await this.cloudStorage.getAllUsers();
                    const bookings = await this.cloudStorage.getAllBookings();
                    const today = new Date().toISOString().split('T')[0];
                    const todayBookings = bookings.filter(booking => booking.date === today && booking.status !== 'cancelled');

                    document.getElementById('homeTotalUsers').textContent = users.length;
                    document.getElementById('homeTotalBookings').textContent = bookings.filter(b => b.status !== 'cancelled').length;
                    document.getElementById('homeTodayBookings').textContent = todayBookings.length;
                } catch (error) {
                    console.error('Load home stats error:', error);
                }
            }

            getBookingKey(date, time) {
                return `${date}_${time}`;
            }

            async loadBookingsToCache() {
                try {
                    console.log('é–‹å§‹è¼‰å…¥é ç´„è³‡æ–™...');
                    const allBookings = await this.cloudStorage.getAllBookings();
                    
                    this.bookingsCache = {};
                    
                    allBookings.forEach(booking => {
                        if (booking.status === 'confirmed') {
                            const key = this.getBookingKey(booking.date, booking.time);
                            this.bookingsCache[key] = booking;
                        }
                    });
                    
                    console.log('å¿«å–å»ºç«‹å®Œæˆï¼Œå…±', Object.keys(this.bookingsCache).length, 'ç­†é ç´„');
                    return true;
                } catch (error) {
                    console.error('è¼‰å…¥é ç´„å¿«å–å¤±æ•—:', error);
                    return false;
                }
            }

            getBookingFromCache(date, time) {
                const key = this.getBookingKey(date, time);
                return this.bookingsCache[key] || null;
            }

            addBookingToCache(booking) {
                const key = this.getBookingKey(booking.date, booking.time);
                this.bookingsCache[key] = booking;
            }

            async confirmBooking() {
                const name = document.getElementById('bookingName').value;
                const notes = document.getElementById('bookingNotes').value;
                
                if (!name) {
                    this.showMessage('è«‹è¼¸å…¥åç¨±æˆ–åœ˜å', 'error');
                    return;
                }
                
                const bookingData = {
                    email: this.currentUser.email,
                    realName: this.currentUser.realName,
                    date: this.selectedDate,
                    time: this.selectedTime,
                    type: this.selectedType,
                    name: name,
                    notes: notes
                };
                
                try {
                    console.log('é–‹å§‹é ç´„æµç¨‹...', bookingData);
                    
                    const existingBooking = this.getBookingFromCache(this.selectedDate, this.selectedTime);
                    if (existingBooking) {
                        this.showMessage('è©²æ™‚æ®µå·²è¢«é ç´„', 'error');
                        return;
                    }
                    
                    const newBooking = await this.cloudStorage.createBooking(bookingData);
                    this.addBookingToCache(newBooking);
                    
                    console.log('é ç´„å‰µå»ºæˆåŠŸï¼Œé–‹å§‹ç™¼é€éƒµä»¶...');

                    // ç™¼é€ç®¡ç†å“¡é€šçŸ¥
                    console.log('æº–å‚™ç™¼é€ç®¡ç†å“¡é€šçŸ¥...');
                    const adminSent = await emailService.sendAdminNotification('new_booking', {
                        realName: this.currentUser.realName,
                        email: this.currentUser.email,
                        bookingDate: bookingData.date,
                        bookingTime: bookingData.time,
                        bookingType: this.getTypeText(bookingData.type),
                        bookingName: bookingData.name,
                        bookingNotes: bookingData.notes
                    });
                    
                    // ç™¼é€ç”¨æˆ¶ç¢ºèªä¿¡
                    console.log('æº–å‚™ç™¼é€ç”¨æˆ¶ç¢ºèªä¿¡...');
                    const userSent = await emailService.sendUserNotification('booking_confirmation', {
                        userEmail: this.currentUser.email,
                        realName: this.currentUser.realName,
                        bookingDate: bookingData.date,
                        bookingTime: bookingData.time,
                        bookingType: this.getTypeText(bookingData.type),
                        bookingName: bookingData.name,
                        bookingNotes: bookingData.notes,
                        bookingId: newBooking.id
                    });
                    
                    console.log('éƒµä»¶ç™¼é€çµæœ - ç®¡ç†å“¡:', adminSent, 'ç”¨æˆ¶:', userSent);
                    
                    this.closeModal();
                    if (userSent) {
                        this.showMessage('é ç´„æˆåŠŸï¼ç¢ºèªä¿¡å·²ç™¼é€åˆ°æ‚¨çš„ä¿¡ç®±', 'success');
                    } else {
                        this.showMessage('é ç´„æˆåŠŸï¼ä½†ç¢ºèªä¿¡ç™¼é€å¤±æ•—ï¼Œè«‹æˆªåœ–ä¿å­˜é ç´„è³‡è¨Š', 'warning');
                    }
                    await this.renderTimelineCalendar();
                    
                } catch (error) {
                    console.error('é ç´„éç¨‹ä¸­å‡ºéŒ¯:', error);
                    this.showMessage(error.message, 'error');
                }
            }

            async changeWeek(weeks) {
                const newDate = new Date(this.currentWeekStart);
                newDate.setDate(newDate.getDate() + (weeks * 7));
                
                const maxDate = new Date();
                maxDate.setMonth(maxDate.getMonth() + 2);
                
                if (newDate > maxDate && weeks > 0) {
                    this.showMessage('åªèƒ½é ç´„å…©å€‹æœˆå…§çš„æ™‚æ®µ', 'warning');
                    return;
                }
                
                this.currentWeekStart = newDate;
                await this.renderTimelineCalendar();
            }

            async goToToday() {
                this.currentWeekStart = new Date(this.getWeekStartDate(new Date()));
                await this.renderTimelineCalendar();
                
                if (window.innerWidth <= 768) {
                    const today = new Date();
                    const todayStr = this.formatDate(today);
                    const todayElement = document.querySelector(`[data-date="${todayStr}"]`);
                    if (todayElement) {
                        todayElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }
            }

            formatDate(date) {
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const day = date.getDate();
                return `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
            }

            formatDisplayDate(date) {
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                const weekDay = weekDays[date.getDay()];
                return `${month}/${day} é€±${weekDay}`;
            }

            isPastDate(date) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                return date < today;
            }

            isWithinTwoMonths(date) {
                const today = new Date();
                const twoMonthsLater = new Date();
                twoMonthsLater.setMonth(today.getMonth() + 2);
                return date <= twoMonthsLater;
            }

            isPastTimeSlot(date, time) {
                const now = new Date();
                const [hours, minutes] = time.split(':').map(Number);
                const slotDateTime = new Date(date);
                slotDateTime.setHours(hours, minutes, 0, 0);
                return slotDateTime < now;
            }

            getTypeText(type) {
                const typeMap = {
                    'fixed': 'å›ºå®šç·´åœ˜',
                    'personal': 'å€‹äººç·´ç¿’',
                    'free': 'è‡ªç”±ç·´åœ˜'
                };
                return typeMap[type] || type;
            }

            getWeekOfMonth(date) {
                const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
                const firstDayOfWeek = firstDay.getDay() || 7;
                
                const currentDate = date.getDate();
                
                const weekNumber = Math.ceil((currentDate + firstDayOfWeek - 1) / 7);
                
                return Math.min(weekNumber, 4);
            }

            getWeekDisplay(startDate) {
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);
                
                const startMonth = startDate.getMonth() + 1;
                const endMonth = endDate.getMonth() + 1;
                const startYear = startDate.getFullYear();
                const endYear = endDate.getFullYear();
                
                if (startYear === endYear && startMonth === endMonth) {
                    const weekNumber = this.getWeekOfMonth(startDate);
                    const displayWeek = Math.min(weekNumber, 4);
                    return `${startYear}å¹´${startMonth}æœˆ ç¬¬${displayWeek}é€±`;
                } 
                else if (startYear === endYear) {
                    const startWeek = this.getWeekOfMonth(startDate);
                    const endWeek = this.getWeekOfMonth(endDate);
                    const displayStartWeek = Math.min(startWeek, 4);
                    const displayEndWeek = Math.min(endWeek, 4);
                    return `${startYear}å¹´${startMonth}æœˆç¬¬${displayStartWeek}é€±-${endMonth}æœˆç¬¬${displayEndWeek}é€±`;
                }
                else {
                    const startWeek = this.getWeekOfMonth(startDate);
                    const endWeek = this.getWeekOfMonth(endDate);
                    const displayStartWeek = Math.min(startWeek, 4);
                    const displayEndWeek = Math.min(endWeek, 4);
                    return `${startYear}å¹´${startMonth}æœˆç¬¬${displayStartWeek}é€±-${endYear}å¹´${endMonth}æœˆç¬¬${displayEndWeek}é€±`;
                }
            }

            async renderTimelineCalendar() {
                console.log('é–‹å§‹æ¸²æŸ“æ—¥æ›†...');
                const startTime = Date.now();
                
                await this.loadBookingsToCache();
                
                const container = document.getElementById('timelineContainer');
                container.innerHTML = '';
                
                const weekDisplay = document.getElementById('currentWeekDisplay');
                if (weekDisplay) {
                    weekDisplay.textContent = this.getWeekDisplay(this.currentWeekStart);
                }
                
                const timeSlots = ['09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00'];
                const isMobile = window.innerWidth <= 768;
                
                if (!isMobile) {
                    const timeColumn = document.createElement('div');
                    timeColumn.className = 'time-column';
                    
                    const emptyHeader = document.createElement('div');
                    emptyHeader.className = 'time-slot-header';
                    emptyHeader.textContent = 'æ™‚é–“';
                    timeColumn.appendChild(emptyHeader);
                    
                    timeSlots.forEach(time => {
                        const timeHeader = document.createElement('div');
                        timeHeader.className = 'time-slot-header';
                        timeHeader.textContent = time;
                        timeColumn.appendChild(timeHeader);
                    });
                    
                    container.appendChild(timeColumn);
                }
                
                const daysContainer = document.createElement('div');
                daysContainer.className = 'days-container';
                
                const weekDates = [];
                for (let i = 0; i < 7; i++) {
                    const date = new Date(this.currentWeekStart);
                    date.setDate(this.currentWeekStart.getDate() + i);
                    weekDates.push({
                        date: date,
                        dateStr: this.formatDate(date)
                    });
                }
                
                const now = new Date();
                
                weekDates.forEach(dayInfo => {
                    const dayColumn = document.createElement('div');
                    dayColumn.className = 'day-column';
                    dayColumn.setAttribute('data-date', dayInfo.dateStr);
                    
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'day-header';
                    dayHeader.innerHTML = `
                        <div class="day-name">${this.formatDisplayDate(dayInfo.date)}</div>
                        <div class="day-date">${dayInfo.dateStr}</div>
                    `;
                    dayColumn.appendChild(dayHeader);
                    
                    const timeSlotsContainer = document.createElement('div');
                    timeSlotsContainer.className = 'time-slots';
                    
                    timeSlots.forEach(time => {
                        const timeSlot = document.createElement('div');
                        timeSlot.className = 'time-slot';
                        
                        if (isMobile) {
                            const timeDisplay = document.createElement('div');
                            timeDisplay.className = 'mobile-time-display';
                            timeDisplay.textContent = time;
                            timeSlot.appendChild(timeDisplay);
                        }
                        
                        const booking = this.getBookingFromCache(dayInfo.dateStr, time);
                        const [hours, minutes] = time.split(':').map(Number);
                        const slotDateTime = new Date(dayInfo.date);
                        slotDateTime.setHours(hours, minutes, 0, 0);
                        
                        const isPast = slotDateTime < now;
                        const isWithinTwoMonths = this.isWithinTwoMonths(dayInfo.date);
                        
                        if (booking) {
                            timeSlot.className += ' booked';
                            timeSlot.title = `å·²é ç´„ï¼š${booking.name} (${booking.real_name}) - ${this.getTypeText(booking.type)}`;
                            
                            if (this.currentUser && booking.user_email === this.currentUser.email) {
                                timeSlot.className += ' own-booking';
                            }
                            
                            const bookingInfo = document.createElement('div');
                            bookingInfo.className = 'booking-info';
                            bookingInfo.innerHTML = `
                                <div class="booking-name" title="${booking.name}">${this.truncateText(booking.name, isMobile ? 20 : 6)}</div>
                                <div class="booking-type" title="${this.getTypeText(booking.type)}">${this.getTypeText(booking.type)}</div>
                            `;
                            timeSlot.appendChild(bookingInfo);
                        } else if (isPast) {
                            timeSlot.className += ' past';
                            const statusText = document.createElement('div');
                            statusText.className = 'status-text';
                            statusText.textContent = 'å·²éæœŸ';
                            timeSlot.appendChild(statusText);
                            timeSlot.title = 'æ­¤æ™‚é–“æ®µå·²éæœŸï¼Œç„¡æ³•é ç´„';
                        } else if (!isWithinTwoMonths) {
                            timeSlot.className += ' future-limit';
                            const statusText = document.createElement('div');
                            statusText.className = 'status-text';
                            statusText.textContent = 'ä¸å¯é ç´„';
                            timeSlot.appendChild(statusText);
                            timeSlot.title = 'åªèƒ½é ç´„å…©å€‹æœˆå…§çš„æ™‚æ®µ';
                        } else {
                            timeSlot.className += ' available';
                            const statusText = document.createElement('div');
                            statusText.className = 'status-text';
                            statusText.textContent = 'å¯é ç´„';
                            timeSlot.appendChild(statusText);
                            timeSlot.title = 'é»æ“Šé ç´„æ­¤æ™‚é–“æ®µ';
                            timeSlot.addEventListener('click', () => {
                                this.openBookingModal(dayInfo.dateStr, time);
                            });
                        }
                        
                        timeSlotsContainer.appendChild(timeSlot);
                    });
                    
                    dayColumn.appendChild(timeSlotsContainer);
                    daysContainer.appendChild(dayColumn);
                });
                
                container.appendChild(daysContainer);
                
                const endTime = Date.now();
                console.log(`æ—¥æ›†æ¸²æŸ“å®Œæˆï¼Œè€—æ™‚: ${endTime - startTime}ms`);
            }

            truncateText(text, maxLength) {
                if (!text) return '';
                if (text.length <= maxLength) return text;
                return text.substring(0, maxLength) + '...';
            }

            openBookingModal(date, time) {
                if (!this.currentUser || this.currentUser.status !== 'approved') {
                    this.showMessage('è«‹å…ˆå®Œæˆå¸³è™Ÿå¯©æ ¸æ‰èƒ½é ç´„', 'error');
                    return;
                }

                if (this.isPastTimeSlot(date, time)) {
                    this.showMessage('ç„¡æ³•é ç´„éå»çš„æ™‚é–“æ®µ', 'error');
                    return;
                }

                const slotDate = new Date(date);
                if (!this.isWithinTwoMonths(slotDate)) {
                    this.showMessage('åªèƒ½é ç´„å…©å€‹æœˆå…§çš„æ™‚æ®µ', 'error');
                    return;
                }

                this.selectedDate = date;
                this.selectedTime = time;
                
                const modal = document.getElementById('bookingModal');
                const details = document.getElementById('bookingDetails');
                
                details.innerHTML = `
                    <p><strong>æ—¥æœŸï¼š</strong>${date}</p>
                    <p><strong>æ™‚é–“ï¼š</strong>${time}</p>
                `;
                
                document.getElementById('bookingName').value = this.currentUser.realName || '';
                document.getElementById('bookingNotes').value = '';
                
                modal.style.display = 'flex';
            }

            closeModal() {
                document.getElementById('bookingModal').style.display = 'none';
            }

            async renderAdminPanel() {
                if (!this.currentUser || !this.cloudStorage.isAdmin(this.currentUser)) return;
                
                const users = await this.cloudStorage.getAllUsers();
                const bookings = await this.cloudStorage.getAllBookings();
                const pendingUsers = await this.cloudStorage.getPendingUsers();
                const today = new Date().toISOString().split('T')[0];
                const todayBookings = bookings.filter(booking => booking.date === today && booking.status !== 'cancelled');

                document.getElementById('totalUsers').textContent = users.length;
                document.getElementById('pendingUsers').textContent = pendingUsers.length;
                document.getElementById('totalBookings').textContent = bookings.filter(b => b.status !== 'cancelled').length;
                document.getElementById('todayBookings').textContent = todayBookings.length;
                
                this.renderPendingUsers(pendingUsers);
                this.renderTodayBookings(todayBookings);
                this.renderAllBookings(bookings);
                this.renderAllUsers(users);
            }

            renderPendingUsers(users) {
                const container = document.getElementById('pendingUsersList');
                container.innerHTML = '';
                
                if (users.length === 0) {
                    container.innerHTML = '<p>ç„¡å¾…å¯©æ ¸ç”¨æˆ¶</p>';
                    return;
                }
                
                users.forEach(user => {
                    const userEl = document.createElement('div');
                    userEl.className = 'user-item';
                    userEl.innerHTML = `
                        <div class="user-info">
                            <div><strong>å§“åï¼š</strong>${user.real_name}</div>
                            <div><strong>å­¸è™Ÿï¼š</strong>${user.student_id}</div>
                            <div><strong>é›»å­éƒµä»¶ï¼š</strong>${user.email}</div>
                            <div><strong>é›»è©±ï¼š</strong>${user.phone}</div>
                        </div>
                        <div class="user-actions">
                            <button class="btn btn-success btn-sm" onclick="app.approveUser('${user.email}')">æ ¸å‡†</button>
                            <button class="btn btn-danger btn-sm" onclick="app.rejectUser('${user.email}')">æ‹’çµ•</button>
                        </div>
                    `;
                    container.appendChild(userEl);
                });
            }

            renderTodayBookings(bookings) {
                const container = document.getElementById('todayBookingsList');
                container.innerHTML = '';
                
                if (bookings.length === 0) {
                    container.innerHTML = '<p>ä»Šæ—¥ç„¡é ç´„</p>';
                    return;
                }
                
                bookings.forEach(booking => {
                    const bookingEl = document.createElement('div');
                    bookingEl.className = 'booking-item';
                    bookingEl.innerHTML = `
                        <div class="booking-info">
                            <div><strong>åç¨±ï¼š</strong>${booking.name}</div>
                            <div><strong>é ç´„äººï¼š</strong>${booking.real_name} (${booking.user_email})</div>
                            <div><strong>æ™‚é–“ï¼š</strong>${booking.time}</div>
                            <div><strong>é¡å‹ï¼š</strong>${this.getTypeText(booking.type)}</div>
                            <div><strong>å‚™è¨»ï¼š</strong>${booking.notes || 'ç„¡'}</div>
                        </div>
                    `;
                    container.appendChild(bookingEl);
                });
            }

            renderAllBookings(bookings) {
                const container = document.getElementById('allBookingsList');
                container.innerHTML = '';
                
                const activeBookings = bookings.filter(b => b.status !== 'cancelled');
                
                if (activeBookings.length === 0) {
                    container.innerHTML = '<p>ç„¡é ç´„è¨˜éŒ„</p>';
                    return;
                }
                
                activeBookings.forEach(booking => {
                    const bookingEl = document.createElement('div');
                    bookingEl.className = 'booking-item';
                    bookingEl.innerHTML = `
                        <div class="booking-info">
                            <div><strong>åç¨±ï¼š</strong>${booking.name}</div>
                            <div><strong>é ç´„äººï¼š</strong>${booking.real_name} (${booking.user_email})</div>
                            <div><strong>æ—¥æœŸï¼š</strong>${booking.date}</div>
                            <div><strong>æ™‚é–“ï¼š</strong>${booking.time}</div>
                            <div><strong>é¡å‹ï¼š</strong>${this.getTypeText(booking.type)}</div>
                            <div><strong>ç‹€æ…‹ï¼š</strong>${booking.status}</div>
                        </div>
                        <div class="booking-actions">
                            <button class="btn btn-danger btn-sm" onclick="app.deleteBooking('${booking.id}')">å–æ¶ˆé ç´„</button>
                        </div>
                    `;
                    container.appendChild(bookingEl);
                });
            }

            renderAllUsers(users) {
                const container = document.getElementById('allUsersList');
                container.innerHTML = '';
                
                users.forEach(user => {
                    const userEl = document.createElement('div');
                    userEl.className = 'user-item';
                    userEl.innerHTML = `
                        <div class="user-info">
                            <div><strong>å§“åï¼š</strong>${user.real_name}</div>
                            <div><strong>å­¸è™Ÿï¼š</strong>${user.student_id}</div>
                            <div><strong>é›»å­éƒµä»¶ï¼š</strong>${user.email}</div>
                            <div><strong>ç‹€æ…‹ï¼š</strong><span class="status-${user.status}">${user.status}</span></div>
                        </div>
                        <div class="user-actions">
                            <button class="btn btn-danger btn-sm" onclick="app.deleteUser('${user.email}')">åˆªé™¤ç”¨æˆ¶</button>
                        </div>
                    `;
                    container.appendChild(userEl);
                });
            }

            async approveUser(email) {
    try {
        const users = await this.cloudStorage.getAllUsers();
        const userToApprove = users.find(user => user.email === email);
        
        if (!userToApprove) {
            this.showMessage('æ‰¾ä¸åˆ°è©²ç”¨æˆ¶', 'error');
            return;
        }

        await this.cloudStorage.approveUser(email);
        
        try {
            // ç™¼é€å¯©æ ¸é€šéé€šçŸ¥çµ¦ç”¨æˆ¶
            await emailService.sendUserNotification('approval_result', {
                userEmail: email,
                realName: userToApprove.real_name,
                studentId: userToApprove.student_id,
                status: 'approved',
                notes: 'æ‚¨çš„å¸³è™Ÿå·²é€šéå¯©æ ¸ï¼Œè«‹é‡æ–°ç™»å…¥ç³»çµ±ä»¥å•Ÿç”¨é ç´„åŠŸèƒ½ã€‚'
            });
            this.showMessage('ç”¨æˆ¶å·²æ ¸å‡†ï¼Œä¸¦å·²ç™¼é€é€šçŸ¥éƒµä»¶ã€‚è«‹ç”¨æˆ¶é‡æ–°ç™»å…¥ä»¥å•Ÿç”¨é ç´„åŠŸèƒ½ã€‚', 'success');
        } catch (mailError) {
            console.error('éƒµä»¶ç™¼é€å¤±æ•—ï¼Œä½†ç”¨æˆ¶å·²æ ¸å‡†:', mailError);
            this.showMessage('ç”¨æˆ¶å·²æ ¸å‡†ï¼Œä½†é€šçŸ¥éƒµä»¶ç™¼é€å¤±æ•—ã€‚è«‹é€šçŸ¥ç”¨æˆ¶é‡æ–°ç™»å…¥ä»¥å•Ÿç”¨é ç´„åŠŸèƒ½ã€‚', 'warning');
        }
        
        await this.renderAdminPanel();
        
    } catch (error) {
        this.showMessage('æ ¸å‡†å¤±æ•—ï¼š' + error.message, 'error');
    }
}

            async rejectUser(email) {
                try {
                    await this.cloudStorage.rejectUser(email);
                    this.showMessage('ç”¨æˆ¶å·²æ‹’çµ•', 'success');
                    this.renderAdminPanel();
                } catch (error) {
                    this.showMessage('æ‹’çµ•å¤±æ•—ï¼š' + error.message, 'error');
                }
            }

            async deleteUser(email) {
                if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç”¨æˆ¶å—ï¼Ÿæ­¤æ“ä½œå°‡åŒæ™‚åˆªé™¤è©²ç”¨æˆ¶çš„æ‰€æœ‰é ç´„è¨˜éŒ„ï¼Œä¸”ç„¡æ³•å¾©åŸï¼')) {
                    return;
                }

                try {
                    await this.cloudStorage.deleteUser(email);
                    this.showMessage('ç”¨æˆ¶å·²æˆåŠŸåˆªé™¤', 'success');
                    await this.renderAdminPanel();
                } catch (error) {
                    this.showMessage('åˆªé™¤ç”¨æˆ¶å¤±æ•—ï¼š' + error.message, 'error');
                }
            }

            async deleteBooking(bookingId) {
                try {
                    await this.cloudStorage.cancelBooking(bookingId);
                    this.showMessage('é ç´„å·²å–æ¶ˆ', 'success');
                    this.renderAdminPanel();
                    if (this.currentView === 'calendar') {
                        this.renderTimelineCalendar();
                    }
                } catch (error) {
                    this.showMessage('å–æ¶ˆé ç´„å¤±æ•—ï¼š' + error.message, 'error');
                }
            }
        }

        // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
        const app = new BandRoomApp();
    </script>
</body>
</html>