<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ—å•†ç†±éŸ³ç¤¾ - ç·´åœ˜å®¤é ç´„ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --primary-light: #dbeafe;
            --secondary: #f0f9ff;
            --accent: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --text-dark: #1e293b;
            --text-light: #64748b;
            --text-white: #ffffff;
            --gray-light: #f1f5f9;
            --gray: #e2e8f0;
            --gray-dark: #94a3b8;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --radius: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background: var(--secondary);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* å°èˆªæ¬„ */
        .navbar {
            background: white;
            border-bottom: 1px solid var(--gray);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .nav-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .nav-menu {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .nav-item {
            color: var(--text-dark);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: var(--radius);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-item:hover {
            background: var(--primary-light);
            color: var(--primary-dark);
        }

        .nav-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--primary);
            cursor: pointer;
            padding: 0.5rem;
        }

        .hidden {
            display: none !important;
        }

        /* ä¸»è¦å…§å®¹ */
        .main-content {
            flex: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            width: 100%;
        }

        .card {
            background: white;
            border-radius: var(--radius);
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--primary-light);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* æŒ‰éˆ• */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--gray-light);
            color: var(--text-dark);
        }

        .btn-secondary:hover {
            background: var(--gray);
        }

        .btn-success {
            background: var(--accent);
            color: white;
        }

        .btn-danger {
            background: var(--error);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* æ™‚é–“è»¸æ—¥æ›†æ¨£å¼ */
        .timeline-calendar {
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            background: var(--primary);
            color: white;
        }

        .calendar-nav {
            display: flex;
            gap: 0.5rem;
        }

        .timeline-container {
            display: flex;
            min-height: 600px;
        }

        .time-column {
            width: 80px;
            background: var(--gray-light);
            border-right: 1px solid var(--gray);
        }

        .time-slot-header {
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            color: var(--text-dark);
            border-bottom: 1px solid var(--gray);
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .days-container {
            flex: 1;
            display: flex;
        }

        .day-column {
            flex: 1;
            border-right: 1px solid var(--gray);
        }

        .day-column:last-child {
            border-right: none;
        }

        .day-header {
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            background: var(--primary-light);
            color: var(--primary-dark);
            border-bottom: 1px solid var(--gray);
            height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .day-name {
            font-size: 0.9rem;
            font-weight: 700;
        }

        .day-date {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        /* å„ªåŒ–æ™‚é–“æ ¼å­æ¨£å¼ */
        .time-slot {
            height: 60px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            padding: 4px;
            font-size: 0.8rem;
            text-align: center;
            transition: all 0.2s ease;
        }

        /* å„ªåŒ–é ç´„è³‡è¨Šé¡¯ç¤º */
        .booking-info {
            font-size: 0.7rem;
            text-align: center;
            padding: 2px;
            width: 100%;
            overflow: hidden;
        }

        .booking-name {
            font-weight: 700;
            margin-bottom: 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.65rem;
        }

        .booking-type {
            font-size: 0.6rem;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* å„ªåŒ–ç‹€æ…‹æ–‡å­—é¡¯ç¤º */
        .status-text {
            font-size: 0.75rem;
            font-weight: 500;
            text-align: center;
        }

        /* ç¢ºä¿é ç´„è³‡è¨Šæ­£ç¢ºå±…ä¸­ */
        .booking-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            padding: 2px;
        }

        .booking-name {
            font-weight: 700;
            margin-bottom: 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.65rem;
            max-width: 100%;
            text-align: center;
        }

        .booking-type {
            font-size: 0.6rem;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            text-align: center;
        }

        /* å„ªåŒ–æ™‚é–“æ ¼å­çš„æ•´é«”ä½ˆå±€ */
        .time-slot {
            height: 60px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            padding: 2px;
            font-size: 0.8rem;
            text-align: center;
            transition: all 0.2s ease;
        }

        /* ç¢ºä¿æ‰€æœ‰å…§å®¹éƒ½æ­£ç¢ºå±…ä¸­ */
        .time-slot > * {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }

        /* å„ªåŒ–ä¸åŒç‹€æ…‹çš„è¦–è¦ºæ•ˆæœ */
        .time-slot.available {
            background: rgba(16, 185, 129, 0.05);
        }

        .time-slot.available:hover {
            background: rgba(16, 185, 129, 0.1);
        }

        .time-slot.booked {
            background: rgba(245, 158, 11, 0.1);
            cursor: not-allowed;
        }

        .time-slot.own-booking {
            background: rgba(59, 130, 246, 0.1);
        }

        .time-slot.past {
            background: rgba(100, 116, 139, 0.05);
            color: var(--text-light);
            cursor: not-allowed;
        }

        .time-slot.future-limit {
            background: rgba(100, 116, 139, 0.02);
            color: var(--text-light);
            cursor: not-allowed;
        }

        .status-pending { 
            color: var(--warning); 
            font-weight: 700;
            background: rgba(245, 158, 11, 0.1);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        .status-approved { 
            color: var(--accent); 
            font-weight: 700;
            background: rgba(16, 185, 129, 0.1);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        .status-rejected { 
            color: var(--error); 
            font-weight: 700;
            background: rgba(239, 68, 68, 0.1);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .user-item, .booking-item {
            background: white;
            border: 1px solid var(--gray);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .user-info, .booking-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .user-actions, .booking-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 1.5rem;
            border-radius: var(--radius);
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius);
            padding: 2rem;
            width: 90%;
            max-width: 500px;
        }

        .type-option {
            flex: 1;
            text-align: center;
            padding: 10px;
            border: 2px solid var(--gray);
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 500;
        }

        .type-option.selected {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary);
        }

        .message {
            padding: 12px 16px;
            margin: 1rem 0;
            border-radius: var(--radius);
            text-align: center;
            font-weight: 500;
        }

        .message.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--accent);
            color: var(--accent);
        }

        .message.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }

        .notification-badge {
            background: var(--error);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            margin-left: 5px;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--gray);
            border-radius: var(--radius);
            font-size: 1rem;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .nav-toggle {
                display: block;
            }

            .nav-menu {
                display: none;
                flex-direction: column;
                position: absolute;
                top: 100%;
                left: 0;
                width: 100%;
                background: white;
                box-shadow: var(--shadow);
                padding: 1rem 0;
                z-index: 1000;
            }

            .nav-menu.active {
                display: flex;
            }

            .nav-item {
                padding: 12px 2rem;
                border-bottom: 1px solid var(--gray-light);
                justify-content: flex-start;
            }

            .nav-item:last-child {
                border-bottom: none;
            }

            .main-content {
                padding: 1rem;
            }

            .card {
                padding: 1.5rem;
            }

            .timeline-container {
                flex-direction: column;
                min-height: auto;
            }

            .time-column {
                width: 100%;
                height: 60px;
                display: flex;
                overflow-x: auto;
            }

            .time-slot-header {
                min-width: 80px;
                height: 60px;
            }

            .days-container {
                flex-direction: column;
            }

            .user-info, .booking-info {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .time-slot {
                height: 50px;
                font-size: 0.7rem;
            }
            
            .booking-name {
                font-size: 0.6rem;
            }
            
            .booking-type {
                font-size: 0.55rem;
            }
            
            .day-header,
            .time-slot-header {
                height: 45px;
            }
            
            .status-text {
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- å°èˆªæ¬„ -->
        <nav class="navbar">
            <div class="nav-container">
                <div class="nav-logo">
                    <i class="fas fa-guitar"></i>
                    <span>åŒ—å•†ç†±éŸ³ç¤¾</span>
                </div>
                
                <!-- æ¼¢å ¡é¸å–®æŒ‰éˆ• -->
                <button class="nav-toggle" id="navToggle">
                    <i class="fas fa-bars"></i>
                </button>
                
                <div class="nav-menu" id="navMenu">
                    <a href="#" class="nav-item" data-view="home">é¦–é </a>
                    <a href="#" class="nav-item" data-view="login" id="loginNav">ç™»å…¥</a>
                    <a href="#" class="nav-item" data-view="signup" id="signupNav">è¨»å†Š</a>
                    <a href="#" class="nav-item hidden" data-view="profile" id="profileNav">å€‹äººè³‡æ–™</a>
                    <a href="#" class="nav-item hidden" data-view="calendar" id="calendarNav">é ç´„ç·´åœ˜</a>
                    <a href="#" class="nav-item hidden" data-view="admin" id="adminNav">
                        ç®¡ç†å¾Œå°
                        <span class="notification-badge hidden" id="adminNotification">0</span>
                    </a>
                    <a href="#" class="nav-item hidden" id="logoutNav">ç™»å‡º</a>
                </div>
            </div>
        </nav>

        <!-- ä¸»è¦å…§å®¹ -->
        <main class="main-content">
            <!-- è¨Šæ¯é¡¯ç¤º -->
            <div id="messageContainer"></div>

            <!-- é¦–é å…§å®¹ -->
            <section class="card" id="homeSection">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-home"></i> æ­¡è¿ä½¿ç”¨ç·´åœ˜å®¤é ç´„ç³»çµ±</h2>
                </div>
                <p>è«‹å…ˆè¨»å†Šå¸³è™Ÿä¸¦å¡«å¯«å€‹äººè³‡æ–™ï¼Œç¶“ç®¡ç†å“¡å¯©æ ¸å¾Œå³å¯é ç´„ç·´åœ˜æ™‚é–“ã€‚</p>
                
                <div class="stats-grid" style="margin-top: 2rem;">
                    <div class="stat-card">
                        <div class="stat-number" id="homeTotalUsers">0</div>
                        <div class="stat-label">ç¸½ç”¨æˆ¶æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="homeTotalBookings">0</div>
                        <div class="stat-label">ç¸½é ç´„æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="homeTodayBookings">0</div>
                        <div class="stat-label">ä»Šæ—¥é ç´„</div>
                    </div>
                </div>
            </section>

            <!-- ç™»å…¥è¡¨å–® -->
            <section class="card hidden" id="loginSection">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-sign-in-alt"></i> ç™»å…¥å¸³è™Ÿ</h2>
                </div>
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">é›»å­éƒµä»¶</label>
                        <input type="email" class="form-control" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å¯†ç¢¼</label>
                        <input type="password" class="form-control" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary">ç™»å…¥</button>
                </form>
                <p style="margin-top: 1rem; text-align: center;">
                    é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ <a href="#" data-view="signup" style="color: var(--primary);">ç«‹å³è¨»å†Š</a>
                </p>
            </section>

            <!-- è¨»å†Šè¡¨å–® -->
            <section class="card hidden" id="signupSection">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-user-plus"></i> è¨»å†Šæ–°å¸³è™Ÿ</h2>
                </div>
                <form id="signupForm">
                    <div class="form-group">
                        <label class="form-label">é›»å­éƒµä»¶</label>
                        <input type="email" class="form-control" id="signupEmail" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å¯†ç¢¼</label>
                        <input type="password" class="form-control" id="signupPassword" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç¢ºèªå¯†ç¢¼</label>
                        <input type="password" class="form-control" id="signupConfirmPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary">è¨»å†Š</button>
                </form>
                <p style="margin-top: 1rem; text-align: center;">
                    å·²ç¶“æœ‰å¸³è™Ÿï¼Ÿ <a href="#" data-view="login" style="color: var(--primary);">ç«‹å³ç™»å…¥</a>
                </p>
            </section>

            <!-- å€‹äººè³‡æ–™è¡¨å–® -->
            <section class="card hidden" id="profileSection">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-user"></i> å€‹äººè³‡æ–™</h2>
                </div>
                <form id="profileForm">
                    <div class="form-group">
                        <label class="form-label">çœŸå¯¦å§“å</label>
                        <input type="text" class="form-control" id="realName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å­¸è™Ÿ</label>
                        <input type="text" class="form-control" id="studentId" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">è¯çµ¡é›»è©±</label>
                        <input type="tel" class="form-control" id="phone" required>
                    </div>
                    <button type="submit" class="btn btn-primary">æäº¤è³‡æ–™ç­‰å¾…å¯©æ ¸</button>
                </form>
            </section>

            <!-- æ™‚é–“è»¸æ—¥æ›† -->
            <section class="card hidden" id="calendarSection">
                <div class="timeline-calendar">
                    <div class="calendar-header">
                        <h2 id="currentWeekDisplay">2024å¹´11æœˆ ç¬¬1é€±</h2>
                        <div class="calendar-nav">
                            <button id="prevWeek" class="btn btn-secondary"><i class="fas fa-chevron-left"></i></button>
                            <button id="todayBtn" class="btn btn-secondary">ä»Šå¤©</button>
                            <button id="nextWeek" class="btn btn-secondary"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    
                    <div class="timeline-container" id="timelineContainer">
                        <!-- æ™‚é–“è»¸å…§å®¹ç”± JavaScript ç”Ÿæˆ -->
                    </div>
                </div>
            </section>

            <!-- ç®¡ç†å“¡å¾Œå° -->
            <section class="card hidden" id="adminSection">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-cog"></i> ç®¡ç†å“¡å¾Œå°</h2>
                </div>
                
                <!-- çµ±è¨ˆè³‡æ–™ -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalUsers">0</div>
                        <div class="stat-label">ç¸½ç”¨æˆ¶æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pendingUsers">0</div>
                        <div class="stat-label">å¾…å¯©æ ¸ç”¨æˆ¶</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalBookings">0</div>
                        <div class="stat-label">ç¸½é ç´„æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="todayBookings">0</div>
                        <div class="stat-label">ä»Šæ—¥é ç´„</div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 1rem;">å¾…å¯©æ ¸ç”¨æˆ¶ <span class="notification-badge" id="pendingCount">0</span></h3>
                    <div id="pendingUsersList">
                        <!-- å¾…å¯©æ ¸ç”¨æˆ¶åˆ—è¡¨ -->
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 1rem;">ä»Šæ—¥é ç´„ç‹€æ³</h3>
                    <div id="todayBookingsList">
                        <!-- ä»Šæ—¥é ç´„åˆ—è¡¨ -->
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 1rem;">æ‰€æœ‰é ç´„è¨˜éŒ„</h3>
                    <div id="allBookingsList">
                        <!-- æ‰€æœ‰é ç´„è¨˜éŒ„ -->
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 1rem;">æ‰€æœ‰ç”¨æˆ¶</h3>
                    <div id="allUsersList">
                        <!-- æ‰€æœ‰ç”¨æˆ¶åˆ—è¡¨ -->
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- é ç´„æ¨¡æ…‹æ¡† -->
    <div class="modal" id="bookingModal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3>é ç´„ç·´åœ˜æ™‚é–“</h3>
                <button class="btn btn-secondary" id="closeModal">&times;</button>
            </div>
            <div id="bookingDetails"></div>
            <div style="display: flex; gap: 10px; margin-bottom: 1rem;">
                <div class="type-option selected" data-type="fixed">å›ºå®šç·´åœ˜</div>
                <div class="type-option" data-type="personal">å€‹äººç·´ç¿’</div>
                <div class="type-option" data-type="free">è‡ªç”±ç·´åœ˜</div>
            </div>
            <div class="form-group">
                <label class="form-label">åç¨±/åœ˜å</label>
                <input type="text" class="form-control" id="bookingName" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“åæˆ–åœ˜å">
            </div>
            <div class="form-group">
                <label class="form-label">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
                <textarea class="form-control" id="bookingNotes" rows="3" placeholder="å¦‚æœ‰ç‰¹æ®Šéœ€æ±‚è«‹åœ¨æ­¤å¡«å¯«"></textarea>
            </div>
            <button id="confirmBooking" class="btn btn-primary" style="width: 100%;">ç¢ºèªé ç´„</button>
        </div>
    </div>

    <!-- æ·»åŠ  Supabase å®¢æˆ¶ç«¯ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // Supabase é…ç½®
        const SUPABASE_URL = 'https://mpnntoqgzvfpxbvkdseq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1wbm50b3FnenZmcHhidmtkc2VxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMjc5NzgsImV4cCI6MjA3ODgwMzk3OH0.XGGT6Hf8klN54uWJlBbn2_zydSoB3s4O92S-OdA9tX4';

        // é›²ç«¯è³‡æ–™å„²å­˜ï¼ˆä½¿ç”¨ Supabaseï¼‰
        class SupabaseService {
            constructor() {
                this.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            }

            // ç”¨æˆ¶ç™»å…¥
            async login(email, password) {
                try {
                    const { data, error } = await this.supabase
                        .from('users')
                        .select('*')
                        .eq('email', email)
                        .eq('password', password)
                        .single();
                    
                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Login error:', error);
                    throw new Error('é›»å­éƒµä»¶æˆ–å¯†ç¢¼éŒ¯èª¤');
                }
            }

            // ç”¨æˆ¶è¨»å†Š
            async signup(userData) {
                try {
                    // æª¢æŸ¥æ˜¯å¦å·²è¨»å†Š
                    const { data: existingUser } = await this.supabase
                        .from('users')
                        .select('email')
                        .eq('email', userData.email)
                        .single();

                    if (existingUser) {
                        throw new Error('è©²é›»å­éƒµä»¶å·²è¢«è¨»å†Š');
                    }

                    const { data, error } = await this.supabase
                        .from('users')
                        .insert([{
                            email: userData.email,
                            password: userData.password,
                            real_name: userData.realName || '',
                            student_id: userData.studentId || '',
                            phone: userData.phone || '',
                            status: 'pending',
                            avatar: 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&q=80',
                            is_admin: false
                        }])
                        .select()
                        .single();
                    
                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Signup error:', error);
                    throw error;
                }
            }

            // æ›´æ–°ç”¨æˆ¶è³‡æ–™
            async updateUser(email, userData) {
                try {
                    const { data, error } = await this.supabase
                        .from('users')
                        .update({
                            real_name: userData.realName,
                            student_id: userData.studentId,
                            phone: userData.phone,
                            status: 'pending'
                        })
                        .eq('email', email)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Update user error:', error);
                    throw error;
                }
            }

            // å‰µå»ºé ç´„
            async createBooking(bookingData) {
                try {
                    // æª¢æŸ¥æ™‚æ®µæ˜¯å¦å·²è¢«é ç´„
                    const { data: existingBooking } = await this.supabase
                        .from('bookings')
                        .select('*')
                        .eq('date', bookingData.date)
                        .eq('time', bookingData.time)
                        .eq('status', 'confirmed')
                        .single();

                    if (existingBooking) {
                        throw new Error('è©²æ™‚æ®µå·²è¢«é ç´„');
                    }

                    const { data, error } = await this.supabase
                        .from('bookings')
                        .insert([{
                            user_email: bookingData.email,
                            real_name: bookingData.realName,
                            date: bookingData.date,
                            time: bookingData.time,
                            type: bookingData.type,
                            name: bookingData.name,
                            notes: bookingData.notes,
                            status: 'confirmed'
                        }])
                        .select()
                        .single();
                    
                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Create booking error:', error);
                    throw error;
                }
            }

            // ç²å–æ‰€æœ‰é ç´„
            async getAllBookings() {
                try {
                    const { data, error } = await this.supabase
                        .from('bookings')
                        .select('*')
                        .order('date', { ascending: true })
                        .order('time', { ascending: true });
                    
                    if (error) throw error;
                    return data || [];
                } catch (error) {
                    console.error('Get bookings error:', error);
                    return [];
                }
            }

            // ç²å–ç‰¹å®šæ™‚æ®µçš„é ç´„
            async getBookingForTimeSlot(date, time) {
                try {
                    const { data, error } = await this.supabase
                        .from('bookings')
                        .select('*')
                        .eq('date', date)
                        .eq('time', time)
                        .eq('status', 'confirmed')
                        .single();
                    
                    if (error && error.code !== 'PGRST116') throw error;
                    return data || null;
                } catch (error) {
                    console.error('Get booking error:', error);
                    return null;
                }
            }

            // å–æ¶ˆé ç´„
            async cancelBooking(bookingId) {
                try {
                    const { data, error } = await this.supabase
                        .from('bookings')
                        .update({ status: 'cancelled' })
                        .eq('id', bookingId)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Cancel booking error:', error);
                    throw error;
                }
            }

            // ç²å–æ‰€æœ‰ç”¨æˆ¶
            async getAllUsers() {
                try {
                    const { data, error } = await this.supabase
                        .from('users')
                        .select('*');
                    
                    if (error) throw error;
                    return data || [];
                } catch (error) {
                    console.error('Get users error:', error);
                    return [];
                }
            }

            // ç²å–å¾…å¯©æ ¸ç”¨æˆ¶
            async getPendingUsers() {
                try {
                    const { data, error } = await this.supabase
                        .from('users')
                        .select('*')
                        .eq('status', 'pending');
                    
                    if (error) throw error;
                    return data || [];
                } catch (error) {
                    console.error('Get pending users error:', error);
                    return [];
                }
            }

            // æ ¸å‡†ç”¨æˆ¶
            async approveUser(email) {
                try {
                    const { data, error } = await this.supabase
                        .from('users')
                        .update({ status: 'approved' })
                        .eq('email', email)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Approve user error:', error);
                    throw error;
                }
            }

            // æ‹’çµ•ç”¨æˆ¶
            async rejectUser(email) {
                try {
                    const { data, error } = await this.supabase
                        .from('users')
                        .update({ status: 'rejected' })
                        .eq('email', email)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Reject user error:', error);
                    throw error;
                }
            }

            //
            isAdmin(user) {
                return user && (user.is_admin === true || user.is_admin === 'true' || user.email === '11056046@ntub.edu.tw');
            }
        }

        // åˆå§‹åŒ– Supabase æœå‹™
        const supabaseService = new SupabaseService();

class BandRoomApp {
    constructor() {
        this.currentUser = null;
        this.currentDate = new Date();
        this.selectedDate = null;
        this.selectedTime = null;
        this.selectedType = 'fixed';
        this.cloudStorage = supabaseService;
        this.currentView = 'home';
        this.currentWeekStart = new Date(this.getWeekStartDate(new Date()));
        this.bookingsCache = {};
        
        // ä½¿ç”¨æ‚¨æ‰¾åˆ°çš„ Public Key
        emailjs.init("GvMjujaAG9kS-mPCA");
        
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.checkLoginStatus();
        this.showView('home');
        this.loadHomeStats();
    }

    setupEventListeners() {
        document.addEventListener('click', (e) => {
            if (e.target.matches('[data-view]')) {
                e.preventDefault();
                this.showView(e.target.getAttribute('data-view'));
            }
        });

        document.getElementById('loginForm')?.addEventListener('submit', (e) => this.handleLogin(e));
        document.getElementById('signupForm')?.addEventListener('submit', (e) => this.handleSignup(e));
        document.getElementById('profileForm')?.addEventListener('submit', (e) => this.handleProfileUpdate(e));
        document.getElementById('logoutNav')?.addEventListener('click', (e) => this.handleLogout(e));

        document.getElementById('prevWeek')?.addEventListener('click', () => this.changeWeek(-1));
        document.getElementById('nextWeek')?.addEventListener('click', () => this.changeWeek(1));
        document.getElementById('todayBtn')?.addEventListener('click', () => this.goToToday());

        document.getElementById('closeModal')?.addEventListener('click', () => this.closeModal());
        document.getElementById('confirmBooking')?.addEventListener('click', () => this.confirmBooking());

        document.querySelectorAll('.type-option').forEach(option => {
            option.addEventListener('click', (e) => {
                document.querySelectorAll('.type-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                e.target.classList.add('selected');
                this.selectedType = e.target.getAttribute('data-type');
            });
        });
    }

    showView(viewName) {
        this.currentView = viewName;
        
        document.querySelectorAll('section.card').forEach(section => {
            section.classList.add('hidden');
        });
        
        const targetSection = document.getElementById(viewName + 'Section');
        if (targetSection) {
            targetSection.classList.remove('hidden');
        }
        
        switch(viewName) {
            case 'calendar':
                this.renderTimelineCalendar();
                break;
            case 'admin':
                if (this.currentUser && this.cloudStorage.isAdmin(this.currentUser)) {
                    this.renderAdminPanel();
                } else {
                    this.showView('home');
                    this.showMessage('æ‚¨æ²’æœ‰ç®¡ç†å“¡æ¬Šé™', 'error');
                }
                break;
            case 'profile':
                this.loadProfileData();
                break;
        }
    }
async sendApprovalNotification(userEmail, userData) {
    try {
        console.log('ç™¼é€å¯©æ ¸é€šéé€šçŸ¥çµ¦:', userEmail);
        
        const templateParams = {
            to_email: userEmail,
            subject: `ã€å¸³è™Ÿå¯©æ ¸é€šéã€‘${userData.real_name} - åŒ—å•†ç†±éŸ³ç¤¾ç·´åœ˜å®¤ç³»çµ±`,
            real_name: userData.real_name,
            student_id: userData.student_id,
            user_email: userEmail,
            system_url: window.location.origin, // ç³»çµ±ç¶²å€
            approval_time: new Date().toLocaleString('zh-TW')
        };

        console.log('å¯©æ ¸é€šééƒµä»¶åƒæ•¸:', templateParams);

        // ä½¿ç”¨æ–°çš„æ¨¡æ¿ç™¼é€å¯©æ ¸é€šéé€šçŸ¥
        const response = await emailjs.send(
            'service_wqepdk5',
            'template_gjqm3nz', // å¦‚æœå‰µå»ºäº†æ–°æ¨¡æ¿ï¼Œè«‹æ›¿æ›ç‚ºæ–°æ¨¡æ¿ID
            templateParams
        );

        console.log('âœ… å¯©æ ¸é€šéé€šçŸ¥éƒµä»¶ç™¼é€æˆåŠŸï¼');
        return true;
        
    } catch (error) {
        console.error('âŒ å¯©æ ¸é€šéé€šçŸ¥ç™¼é€å¤±æ•—:', error);
        return false;
    }
}
    showMessage(message, type) {
        const messageContainer = document.getElementById('messageContainer');
        const messageEl = document.createElement('div');
        messageEl.className = `message ${type}`;
        messageEl.textContent = message;
        messageContainer.appendChild(messageEl);
        
        setTimeout(() => {
            messageEl.remove();
        }, 3000);
    }

    checkLoginStatus() {
        const savedUser = localStorage.getItem('ntub_currentUser');
        if (savedUser) {
            this.currentUser = JSON.parse(savedUser);
            this.updateNavForLoggedInUser();
        }
    }

    updateNavForLoggedInUser() {
        document.getElementById('loginNav').classList.add('hidden');
        document.getElementById('signupNav').classList.add('hidden');
        document.getElementById('profileNav').classList.remove('hidden');
        document.getElementById('calendarNav').classList.remove('hidden');
        document.getElementById('logoutNav').classList.remove('hidden');
        
        if (this.currentUser && this.cloudStorage.isAdmin(this.currentUser)) {
            document.getElementById('adminNav').classList.remove('hidden');
        }
    }

    async handleSignup(e) {
        e.preventDefault();
        const email = document.getElementById('signupEmail').value;
        const password = document.getElementById('signupPassword').value;
        const confirmPassword = document.getElementById('signupConfirmPassword').value;

        if (password !== confirmPassword) {
            this.showMessage('å¯†ç¢¼ç¢ºèªä¸ä¸€è‡´', 'error');
            return;
        }

        try {
            const newUser = await this.cloudStorage.signup({
                email: email,
                password: password,
                realName: '',
                studentId: '',
                phone: ''
            });

            this.currentUser = {
                email: newUser.email,
                password: newUser.password,
                realName: newUser.real_name,
                studentId: newUser.student_id,
                phone: newUser.phone,
                status: newUser.status,
                avatar: newUser.avatar,
                isAdmin: newUser.is_admin,
                createdAt: newUser.created_at
            };
            
            localStorage.setItem('ntub_currentUser', JSON.stringify(this.currentUser));
            this.updateNavForLoggedInUser();
            this.showMessage('è¨»å†ŠæˆåŠŸï¼è«‹å¡«å¯«å€‹äººè³‡æ–™', 'success');
            this.showView('profile');
            
        } catch (error) {
            this.showMessage(error.message, 'error');
        }
    }

    async handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        try {
            const user = await this.cloudStorage.login(email, password);
            
            if (user) {
                this.currentUser = {
                    email: user.email,
                    password: user.password,
                    realName: user.real_name,
                    studentId: user.student_id,
                    phone: user.phone,
                    status: user.status,
                    avatar: user.avatar,
                    isAdmin: user.is_admin,
                    createdAt: user.created_at
                };
                
                localStorage.setItem('ntub_currentUser', JSON.stringify(this.currentUser));
                this.updateNavForLoggedInUser();
                this.showMessage('ç™»å…¥æˆåŠŸï¼', 'success');
                
                if (user.status === 'approved') {
                    this.showView('calendar');
                } else {
                    this.showView('profile');
                }
            }
        } catch (error) {
            this.showMessage(error.message, 'error');
        }
    }

    // å¯é çš„éƒµä»¶é€šçŸ¥æ–¹æ³•ï¼ˆå‚™ç”¨æ–¹æ¡ˆï¼‰
    sendEmailNotification(subject, message) {
        const adminEmail = '11056046@ntub.edu.tw';
        const mailtoLink = `mailto:${adminEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(message)}`;
        
        const link = document.createElement('a');
        link.href = mailtoLink;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        console.log('éƒµä»¶é€šçŸ¥å·²æº–å‚™ç™¼é€:', subject);
    }

    // ä½¿ç”¨ EmailJS è‡ªå‹•ç™¼é€éƒµä»¶
    // ä½¿ç”¨ EmailJS è‡ªå‹•ç™¼é€éƒµä»¶
// ä½¿ç”¨ EmailJS è‡ªå‹•ç™¼é€éƒµä»¶ï¼ˆåŠ å…¥è©³ç´°éŒ¯èª¤è™•ç†ï¼‰
// ä½¿ç”¨ EmailJS è‡ªå‹•ç™¼é€éƒµä»¶
// ä½¿ç”¨ EmailJS è‡ªå‹•ç™¼é€éƒµä»¶ï¼ˆä¿®æ­£ç‰ˆï¼‰
// ä½¿ç”¨ EmailJS è‡ªå‹•ç™¼é€éƒµä»¶ï¼ˆé ç´„äººä¹Ÿæ”¶å¾—åˆ°ï¼‰
// ä¿®æ”¹ç™¼é€éƒµä»¶æ–¹æ³•
// ä¿ç•™ä½†ç°¡åŒ–é€™å€‹æ–¹æ³•ï¼Œç”¨æ–¼å…¶ä»–æƒ…æ³
async sendEmailJSNotification(subject, message, type, recipientEmail = null) {
    try {
        console.log('ç™¼é€ä¸€èˆ¬éƒµä»¶...');
        
        const templateParams = {
            to_email: recipientEmail || '11056046@ntub.edu.tw',
            subject: subject,
            message: message,
            type: type,
            timestamp: new Date().toLocaleString('zh-TW')
        };

        console.log('ä¸€èˆ¬éƒµä»¶åƒæ•¸:', templateParams);

        const response = await emailjs.send(
            'service_wqepdk5',
            'template_gjqm3nz',
            templateParams
        );

        console.log('âœ… ä¸€èˆ¬éƒµä»¶ç™¼é€æˆåŠŸï¼');
        return true;
        
    } catch (error) {
        console.error('âŒ ä¸€èˆ¬éƒµä»¶ç™¼é€å¤±æ•—:', error);
        return false;
    }
}

// æ–°å¢å‚™ç”¨æ–¹æ¡ˆé¡¯ç¤º
showFallbackEmailContent(subject, message, recipient) {
    console.log('ğŸ“‹ å‚™ç”¨æ–¹æ¡ˆ - éƒµä»¶å…§å®¹:');
    console.log('æ”¶ä»¶äºº:', recipient);
    console.log('ä¸»é¡Œ:', subject);
    console.log('å…§å®¹:', message);
    
    // å¯ä»¥é¸æ“‡æ€§åœ°é¡¯ç¤ºçµ¦ç”¨æˆ¶çœ‹
    const emailContent = `
ä¸»é¡Œ: ${subject}
æ”¶ä»¶äºº: ${recipient}
å…§å®¹: ${message}
    `;
    
    // å¦‚æœéœ€è¦ï¼Œå¯ä»¥é¡¯ç¤ºåœ¨é é¢ä¸Šè®“ç”¨æˆ¶è¤‡è£½
    // this.showMessage('éƒµä»¶ç™¼é€å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¯ç¹«ç®¡ç†å“¡', 'error');
}

    async handleProfileUpdate(e) {
        e.preventDefault();
        const realName = document.getElementById('realName').value;
        const studentId = document.getElementById('studentId').value;
        const phone = document.getElementById('phone').value;

        try {
            const updatedUser = await this.cloudStorage.updateUser(this.currentUser.email, {
                realName: realName,
                studentId: studentId,
                phone: phone
            });

            this.currentUser.realName = updatedUser.real_name;
            this.currentUser.studentId = updatedUser.student_id;
            this.currentUser.phone = updatedUser.phone;
            this.currentUser.status = updatedUser.status;

            // ç™¼é€ç”¨æˆ¶å¯©æ ¸é€šçŸ¥
            const subject = `ã€ç”¨æˆ¶å¯©æ ¸é€šçŸ¥ã€‘${realName} æäº¤äº†å€‹äººè³‡æ–™`;
            const message = `æ–°çš„ç”¨æˆ¶ç­‰å¾…å¯©æ ¸ï¼š

å§“åï¼š${realName}
å­¸è™Ÿï¼š${studentId}
é›»å­éƒµä»¶ï¼š${this.currentUser.email}
é›»è©±ï¼š${phone}
æäº¤æ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}

è«‹å‰å¾€ç®¡ç†å¾Œå°é€²è¡Œå¯©æ ¸ã€‚`;
            
            // ç™¼é€é€šçŸ¥ï¼ˆå„ªå…ˆä½¿ç”¨ EmailJSï¼‰
            await this.sendEmailJSNotification(subject, message, 'user_approval');
            
            localStorage.setItem('ntub_currentUser', JSON.stringify(this.currentUser));
            this.showMessage('å€‹äººè³‡æ–™å·²æäº¤ï¼Œç­‰å¾…ç®¡ç†å“¡å¯©æ ¸ã€‚å·²ç™¼é€é€šçŸ¥çµ¦ç®¡ç†å“¡', 'success');
            
        } catch (error) {
            this.showMessage('æ›´æ–°å¤±æ•—ï¼š' + error.message, 'error');
        }
    }

    handleLogout(e) {
        e.preventDefault();
        this.currentUser = null;
        localStorage.removeItem('ntub_currentUser');
        
        document.getElementById('loginNav').classList.remove('hidden');
        document.getElementById('signupNav').classList.remove('hidden');
        document.getElementById('profileNav').classList.add('hidden');
        document.getElementById('calendarNav').classList.add('hidden');
        document.getElementById('adminNav').classList.add('hidden');
        document.getElementById('logoutNav').classList.add('hidden');
        
        this.showView('home');
        this.showMessage('å·²æˆåŠŸç™»å‡º', 'success');
    }

    loadProfileData() {
        if (this.currentUser) {
            document.getElementById('realName').value = this.currentUser.realName || '';
            document.getElementById('studentId').value = this.currentUser.studentId || '';
            document.getElementById('phone').value = this.currentUser.phone || '';
        }
    }

    async loadHomeStats() {
        try {
            const users = await this.cloudStorage.getAllUsers();
            const bookings = await this.cloudStorage.getAllBookings();
            const today = new Date().toISOString().split('T')[0];
            const todayBookings = bookings.filter(booking => booking.date === today && booking.status !== 'cancelled');

            document.getElementById('homeTotalUsers').textContent = users.length;
            document.getElementById('homeTotalBookings').textContent = bookings.filter(b => b.status !== 'cancelled').length;
            document.getElementById('homeTodayBookings').textContent = todayBookings.length;
        } catch (error) {
            console.error('Load home stats error:', error);
        }
    }

    // æ—¥æ›†ç›¸é—œæ–¹æ³•
    getBookingKey(date, time) {
        return `${date}_${time}`;
    }

    async loadBookingsToCache() {
        try {
            console.log('é–‹å§‹è¼‰å…¥é ç´„è³‡æ–™...');
            const allBookings = await this.cloudStorage.getAllBookings();
            
            this.bookingsCache = {};
            
            allBookings.forEach(booking => {
                if (booking.status === 'confirmed') {
                    const key = this.getBookingKey(booking.date, booking.time);
                    this.bookingsCache[key] = booking;
                }
            });
            
            console.log('å¿«å–å»ºç«‹å®Œæˆï¼Œå…±', Object.keys(this.bookingsCache).length, 'ç­†é ç´„');
            return true;
        } catch (error) {
            console.error('è¼‰å…¥é ç´„å¿«å–å¤±æ•—:', error);
            return false;
        }
    }

    getBookingFromCache(date, time) {
        const key = this.getBookingKey(date, time);
        return this.bookingsCache[key] || null;
    }

    addBookingToCache(booking) {
        const key = this.getBookingKey(booking.date, booking.time);
        this.bookingsCache[key] = booking;
    }


async confirmBooking() {
    const name = document.getElementById('bookingName').value;
    const notes = document.getElementById('bookingNotes').value;
    
    if (!name) {
        this.showMessage('è«‹è¼¸å…¥åç¨±æˆ–åœ˜å', 'error');
        return;
    }
    
    const bookingData = {
        email: this.currentUser.email,
        realName: this.currentUser.realName,
        date: this.selectedDate,
        time: this.selectedTime,
        type: this.selectedType,
        name: name,
        notes: notes
    };
    
    try {
        console.log('é–‹å§‹é ç´„æµç¨‹...', bookingData);
        
        const existingBooking = this.getBookingFromCache(this.selectedDate, this.selectedTime);
        if (existingBooking) {
            this.showMessage('è©²æ™‚æ®µå·²è¢«é ç´„', 'error');
            return;
        }
        
        const newBooking = await this.cloudStorage.createBooking(bookingData);
        this.addBookingToCache(newBooking);
        
        console.log('é ç´„å‰µå»ºæˆåŠŸï¼Œé–‹å§‹ç™¼é€éƒµä»¶...');
        
        // è©³ç´°çš„èª¿è©¦ä¿¡æ¯
        console.log('=== éƒµä»¶ç™¼é€èª¿è©¦ ===');
        console.log('ç”¨æˆ¶éƒµç®±:', this.currentUser.email);
        console.log('ç”¨æˆ¶éƒµç®±é¡å‹:', typeof this.currentUser.email);
        console.log('ç”¨æˆ¶éƒµç®±æ˜¯å¦æœ‰æ•ˆ:', this.currentUser.email && this.currentUser.email.includes('@'));
        console.log('========================');

        // 1. å…ˆç™¼é€çµ¦ç®¡ç†å“¡
        const adminSubject = `ã€æ–°é ç´„é€šçŸ¥ã€‘${this.currentUser.realName} é ç´„äº†ç·´åœ˜å®¤`;
        const adminMessage = `æ–°çš„ç·´åœ˜å®¤é ç´„è³‡è¨Šï¼š

é ç´„äººï¼š${this.currentUser.realName} (${this.currentUser.email})
æ—¥æœŸï¼š${this.selectedDate}
æ™‚é–“ï¼š${this.selectedTime}
é¡å‹ï¼š${this.getTypeText(this.selectedType)}
åœ˜å/åç¨±ï¼š${name}
å‚™è¨»ï¼š${notes || 'ç„¡'}
é ç´„æ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}

è«‹å‰å¾€ç®¡ç†å¾Œå°æŸ¥çœ‹è©³ç´°è³‡è¨Šã€‚`;

        console.log('æº–å‚™ç™¼é€ç®¡ç†å“¡é€šçŸ¥...');
        await this.sendAdminNotification(adminSubject, adminMessage);
        
        // 2. ç„¶å¾Œç™¼é€çµ¦ç”¨æˆ¶
        console.log('æº–å‚™ç™¼é€ç”¨æˆ¶ç¢ºèªä¿¡...');
        const userEmailSent = await this.sendUserBookingConfirmation(bookingData, name, notes);
        
        console.log('ç”¨æˆ¶éƒµä»¶ç™¼é€çµæœ:', userEmailSent);
        
        this.closeModal();
        if (userEmailSent) {
            this.showMessage('é ç´„æˆåŠŸï¼ç¢ºèªä¿¡å·²ç™¼é€åˆ°æ‚¨çš„ä¿¡ç®±', 'success');
        } else {
            this.showMessage('é ç´„æˆåŠŸï¼ä½†ç¢ºèªä¿¡ç™¼é€å¤±æ•—ï¼Œè«‹æˆªåœ–ä¿å­˜é ç´„è³‡è¨Š', 'warning');
        }
        await this.renderTimelineCalendar();
        
    } catch (error) {
        console.error('é ç´„éç¨‹ä¸­å‡ºéŒ¯:', error);
        this.showMessage(error.message, 'error');
    }
}

// å°ˆé–€ç™¼é€ç”¨æˆ¶é ç´„ç¢ºèªä¿¡çš„æ–¹æ³•


// å°ˆé–€ç™¼é€ç”¨æˆ¶é ç´„ç¢ºèªä¿¡çš„æ–¹æ³•
// å°ˆé–€ç™¼é€ç”¨æˆ¶é ç´„ç¢ºèªä¿¡çš„æ–¹æ³•
// å°ˆé–€ç™¼é€ç”¨æˆ¶é ç´„ç¢ºèªä¿¡çš„æ–¹æ³•ï¼ˆåªä¿ç•™é€™å€‹ï¼‰
// å°ˆé–€ç™¼é€ç®¡ç†å“¡é€šçŸ¥çš„æ–¹æ³•
async sendAdminNotification(subject, message) {
    try {
        console.log('ğŸ”µ ç™¼é€ç®¡ç†å“¡é€šçŸ¥...');
        
        const templateParams = {
            to_email: '11056046@ntub.edu.tw', // ç™¼çµ¦ç®¡ç†å“¡
            subject: subject,
            message: message,
            type: 'admin_notification',
            real_name: this.currentUser.realName,
            user_email: this.currentUser.email,
            timestamp: new Date().toLocaleString('zh-TW')
        };

        console.log('ç®¡ç†å“¡é€šçŸ¥åƒæ•¸:', templateParams);
        console.log('ä½¿ç”¨æ¨¡æ¿: template_94pmhgs');

        // ä½¿ç”¨ç®¡ç†å“¡å°ˆç”¨æ¨¡æ¿
        const response = await emailjs.send(
            'service_wqepdk5',
            'template_94pmhgs', // ç®¡ç†å“¡æ¨¡æ¿
            templateParams
        );

        console.log('âœ… ç®¡ç†å“¡é€šçŸ¥ç™¼é€æˆåŠŸï¼');
        return true;
        
    } catch (error) {
        console.error('âŒ ç®¡ç†å“¡é€šçŸ¥ç™¼é€å¤±æ•—:', error);
        return false;
    }
}
async sendUserBookingConfirmation(bookingData, name, notes) {
    try {
        console.log('ğŸ¯ ç™¼é€ç”¨æˆ¶é ç´„ç¢ºèªä¿¡...');
        console.log('ç”¨æˆ¶éƒµç®±:', this.currentUser.email);
        
        const userSubject = `ã€é ç´„æˆåŠŸã€‘${this.selectedDate} ${this.selectedTime} - ${name} ç·´åœ˜å®¤é ç´„ç¢ºèª`;

        const templateParams = {
            to_email: this.currentUser.email, // ç™¼çµ¦ç”¨æˆ¶
            subject: userSubject,
            real_name: this.currentUser.realName,
            student_id: this.currentUser.studentId,
            user_email: this.currentUser.email,
            user_phone: this.currentUser.phone || 'æœªæä¾›',
            booking_date: this.selectedDate,
            booking_time: this.selectedTime,
            booking_type: this.getTypeText(this.selectedType),
            booking_name: name,
            booking_notes: notes || 'ç„¡',
            timestamp: new Date().toLocaleString('zh-TW')
        };

        console.log('=== ç”¨æˆ¶ç¢ºèªä¿¡è©³ç´°ä¿¡æ¯ ===');
        console.log('æ¨¡æ¿ID: template_gjqm3nz');
        console.log('æ”¶ä»¶äººåƒæ•¸ (to_email):', templateParams.to_email);
        console.log('ç”¨æˆ¶çœŸå¯¦éƒµç®±:', this.currentUser.email);
        console.log('ä¸»é¡Œ:', templateParams.subject);
        console.log('========================');

        const response = await emailjs.send(
            'service_wqepdk5',
            'template_gjqm3nz',
            templateParams
        );

        console.log('âœ… ç”¨æˆ¶ç¢ºèªä¿¡ç™¼é€æˆåŠŸï¼');
        console.log('å›æ‡‰ç‹€æ…‹:', response.status);
        return true;
        
    } catch (error) {
        console.error('âŒ ç”¨æˆ¶ç¢ºèªä¿¡ç™¼é€å¤±æ•—:');
        console.error('éŒ¯èª¤è©³æƒ…:', error);
        return false;
    }
}
// æ¸¬è©¦éƒµä»¶ç™¼é€
async testEmailTemplates() {
    console.log('=== æ¸¬è©¦éƒµä»¶æ¨¡æ¿ ===');
    
    // æ¸¬è©¦ç®¡ç†å“¡æ¨¡æ¿
    console.log('æ¸¬è©¦ç®¡ç†å“¡æ¨¡æ¿ (template_94pmhgs)...');
    try {
        const adminTest = await emailjs.send(
            'service_wqepdk5',
            'template_94pmhgs',
            {
                to_email: '11056046@ntub.edu.tw',
                subject: 'æ¸¬è©¦ç®¡ç†å“¡æ¨¡æ¿',
                message: 'é€™æ˜¯ç®¡ç†å“¡æ¨¡æ¿æ¸¬è©¦'
            }
        );
        console.log('âœ… ç®¡ç†å“¡æ¨¡æ¿æ¸¬è©¦æˆåŠŸ');
    } catch (error) {
        console.error('âŒ ç®¡ç†å“¡æ¨¡æ¿æ¸¬è©¦å¤±æ•—:', error);
    }
    
    // æ¸¬è©¦ç”¨æˆ¶æ¨¡æ¿
    console.log('æ¸¬è©¦ç”¨æˆ¶æ¨¡æ¿ (template_gjqm3nz)...');
    try {
        const userTest = await emailjs.send(
            'service_wqepdk5',
            'template_gjqm3nz',
            {
                to_email: this.currentUser.email,
                subject: 'æ¸¬è©¦ç”¨æˆ¶æ¨¡æ¿',
                real_name: 'æ¸¬è©¦ç”¨æˆ¶',
                student_id: '123456',
                user_email: this.currentUser.email,
                booking_date: '2024-01-01',
                booking_time: '10:00',
                booking_type: 'æ¸¬è©¦é¡å‹',
                booking_name: 'æ¸¬è©¦åœ˜å'
            }
        );
        console.log('âœ… ç”¨æˆ¶æ¨¡æ¿æ¸¬è©¦æˆåŠŸ');
    } catch (error) {
        console.error('âŒ ç”¨æˆ¶æ¨¡æ¿æ¸¬è©¦å¤±æ•—:', error);
    }
}
// å‰µå»ºå‚™ç”¨éƒµä»¶é€£çµ
createFallbackEmail(email, subject, body) {
    const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    console.log('å‚™ç”¨éƒµä»¶é€£çµ:', mailtoLink);
    
    // å¯ä»¥é¸æ“‡æä¾›é€™å€‹é€£çµçµ¦ç”¨æˆ¶
    // const link = document.createElement('a');
    // link.href = mailtoLink;
    // link.click();
}
    // ä¿®æ”¹ changeWeek æ–¹æ³•
    async changeWeek(weeks) {
        const newDate = new Date(this.currentWeekStart);
        newDate.setDate(newDate.getDate() + (weeks * 7));
        
        const maxDate = new Date();
        maxDate.setMonth(maxDate.getMonth() + 2);
        
        if (newDate > maxDate && weeks > 0) {
            this.showMessage('åªèƒ½é ç´„å…©å€‹æœˆå…§çš„æ™‚æ®µ', 'warning');
            return;
        }
        
        this.currentWeekStart = newDate;
        await this.renderTimelineCalendar();
    }

    async goToToday() {
        this.currentWeekStart = new Date(this.getWeekStartDate(new Date()));
        await this.renderTimelineCalendar();
    }

    // è¼”åŠ©æ–¹æ³•
    getWeekStartDate(date) {
        const newDate = new Date(date);
        const day = newDate.getDay();
        const diff = newDate.getDate() - day + (day === 0 ? -6 : 1);
        newDate.setDate(diff);
        newDate.setHours(0, 0, 0, 0);
        return newDate;
    }

    formatDate(date) {
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        return `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
    }

    formatDisplayDate(date) {
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        const weekDay = weekDays[date.getDay()];
        return `${month}/${day} é€±${weekDay}`;
    }

    isPastDate(date) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        return date < today;
    }

    isWithinTwoMonths(date) {
        const today = new Date();
        const twoMonthsLater = new Date();
        twoMonthsLater.setMonth(today.getMonth() + 2);
        return date <= twoMonthsLater;
    }

    isPastTimeSlot(date, time) {
        const now = new Date();
        const [hours, minutes] = time.split(':').map(Number);
        const slotDateTime = new Date(date);
        slotDateTime.setHours(hours, minutes, 0, 0);
        return slotDateTime < now;
    }

    getTypeText(type) {
        const typeMap = {
            'fixed': 'å›ºå®šç·´åœ˜',
            'personal': 'å€‹äººç·´ç¿’',
            'free': 'è‡ªç”±ç·´åœ˜'
        };
        return typeMap[type] || type;
    }

    // ä¿®æ­£ getWeekOfMonth æ–¹æ³•
    getWeekOfMonth(date) {
        const firstDay = new Date(date.getFullYear(), date.getMonth(), 1);
        const firstDayOfWeek = firstDay.getDay() || 7;
        
        const currentDate = date.getDate();
        
        const weekNumber = Math.ceil((currentDate + firstDayOfWeek - 1) / 7);
        
        return Math.min(weekNumber, 4);
    }

    // ä¿®æ”¹é¡¯ç¤ºé€±æ•¸çš„æ–¹æ³•
    getWeekDisplay(startDate) {
        const endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + 6);
        
        const startMonth = startDate.getMonth() + 1;
        const endMonth = endDate.getMonth() + 1;
        const startYear = startDate.getFullYear();
        const endYear = endDate.getFullYear();
        
        if (startYear === endYear && startMonth === endMonth) {
            const weekNumber = this.getWeekOfMonth(startDate);
            const displayWeek = Math.min(weekNumber, 4);
            return `${startYear}å¹´${startMonth}æœˆ ç¬¬${displayWeek}é€±`;
        } 
        else if (startYear === endYear) {
            const startWeek = this.getWeekOfMonth(startDate);
            const endWeek = this.getWeekOfMonth(endDate);
            const displayStartWeek = Math.min(startWeek, 4);
            const displayEndWeek = Math.min(endWeek, 4);
            return `${startYear}å¹´${startMonth}æœˆç¬¬${displayStartWeek}é€±-${endMonth}æœˆç¬¬${displayEndWeek}é€±`;
        }
        else {
            const startWeek = this.getWeekOfMonth(startDate);
            const endWeek = this.getWeekOfMonth(endDate);
            const displayStartWeek = Math.min(startWeek, 4);
            const displayEndWeek = Math.min(endWeek, 4);
            return `${startYear}å¹´${startMonth}æœˆç¬¬${displayStartWeek}é€±-${endYear}å¹´${endMonth}æœˆç¬¬${displayEndWeek}é€±`;
        }
    }

    // renderTimelineCalendar æ–¹æ³•
    async renderTimelineCalendar() {
        console.log('é–‹å§‹æ¸²æŸ“æ—¥æ›†...');
        const startTime = Date.now();
        
        await this.loadBookingsToCache();
        
        const container = document.getElementById('timelineContainer');
        container.innerHTML = '';
        
        // ä½¿ç”¨æ–°çš„é€±æ•¸é¡¯ç¤ºæ–¹æ³•
        const weekDisplay = document.getElementById('currentWeekDisplay');
        if (weekDisplay) {
            weekDisplay.textContent = this.getWeekDisplay(this.currentWeekStart);
        }
        
        const timeSlots = ['09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00'];
        
        // å‰µå»ºæ™‚é–“åˆ—
        const timeColumn = document.createElement('div');
        timeColumn.className = 'time-column';
        
        const emptyHeader = document.createElement('div');
        emptyHeader.className = 'time-slot-header';
        emptyHeader.textContent = 'æ™‚é–“';
        timeColumn.appendChild(emptyHeader);
        
        timeSlots.forEach(time => {
            const timeHeader = document.createElement('div');
            timeHeader.className = 'time-slot-header';
            timeHeader.textContent = time;
            timeColumn.appendChild(timeHeader);
        });
        
        container.appendChild(timeColumn);
        
        // å‰µå»ºæ—¥æœŸåˆ—
        const daysContainer = document.createElement('div');
        daysContainer.className = 'days-container';
        
        const weekDates = [];
        for (let i = 0; i < 7; i++) {
            const date = new Date(this.currentWeekStart);
            date.setDate(this.currentWeekStart.getDate() + i);
            weekDates.push({
                date: date,
                dateStr: this.formatDate(date)
            });
        }
        
        const now = new Date();
        
        // å‰µå»ºæ‰€æœ‰æ™‚é–“æ ¼å­
        weekDates.forEach(dayInfo => {
            const dayColumn = document.createElement('div');
            dayColumn.className = 'day-column';
            
            const dayHeader = document.createElement('div');
            dayHeader.className = 'day-header';
            dayHeader.innerHTML = `
                <div class="day-name">${this.formatDisplayDate(dayInfo.date)}</div>
                <div class="day-date">${dayInfo.dateStr}</div>
            `;
            dayColumn.appendChild(dayHeader);
            
            const timeSlotsContainer = document.createElement('div');
            timeSlotsContainer.className = 'time-slots';
            
            timeSlots.forEach(time => {
                const timeSlot = document.createElement('div');
                timeSlot.className = 'time-slot';
                
                const booking = this.getBookingFromCache(dayInfo.dateStr, time);
                const [hours, minutes] = time.split(':').map(Number);
                const slotDateTime = new Date(dayInfo.date);
                slotDateTime.setHours(hours, minutes, 0, 0);
                
                const isPast = slotDateTime < now;
                const isWithinTwoMonths = this.isWithinTwoMonths(dayInfo.date);
                
                if (booking) {
                    timeSlot.className += ' booked';
                    timeSlot.title = `å·²é ç´„ï¼š${booking.name} (${booking.real_name}) - ${this.getTypeText(booking.type)}`;
                    
                    if (this.currentUser && booking.user_email === this.currentUser.email) {
                        timeSlot.className += ' own-booking';
                    }
                    
                    const bookingInfo = document.createElement('div');
                    bookingInfo.className = 'booking-info';
                    bookingInfo.innerHTML = `
                        <div class="booking-name" title="${booking.name}">${this.truncateText(booking.name, 6)}</div>
                        <div class="booking-type" title="${this.getTypeText(booking.type)}">${this.getTypeText(booking.type)}</div>
                    `;
                    timeSlot.appendChild(bookingInfo);
                } else if (isPast) {
                    timeSlot.className += ' past';
                    timeSlot.innerHTML = '<span class="status-text">å·²éæœŸ</span>';
                    timeSlot.title = 'æ­¤æ™‚é–“æ®µå·²éæœŸï¼Œç„¡æ³•é ç´„';
                } else if (!isWithinTwoMonths) {
                    timeSlot.className += ' future-limit';
                    timeSlot.innerHTML = '<span class="status-text">ä¸å¯é ç´„</span>';
                    timeSlot.title = 'åªèƒ½é ç´„å…©å€‹æœˆå…§çš„æ™‚æ®µ';
                } else {
                    timeSlot.className += ' available';
                    timeSlot.innerHTML = '<span class="status-text">å¯é ç´„</span>';
                    timeSlot.title = 'é»æ“Šé ç´„æ­¤æ™‚é–“æ®µ';
                    timeSlot.addEventListener('click', () => {
                        this.openBookingModal(dayInfo.dateStr, time);
                    });
                }
                
                timeSlotsContainer.appendChild(timeSlot);
            });
            
            dayColumn.appendChild(timeSlotsContainer);
            daysContainer.appendChild(dayColumn);
        });
        
        container.appendChild(daysContainer);
        
        const endTime = Date.now();
        console.log(`æ—¥æ›†æ¸²æŸ“å®Œæˆï¼Œè€—æ™‚: ${endTime - startTime}ms`);
    }

    truncateText(text, maxLength) {
        if (!text) return '';
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }

    openBookingModal(date, time) {
        if (!this.currentUser || this.currentUser.status !== 'approved') {
            this.showMessage('è«‹å…ˆå®Œæˆå¸³è™Ÿå¯©æ ¸æ‰èƒ½é ç´„', 'error');
            return;
        }

        if (this.isPastTimeSlot(date, time)) {
            this.showMessage('ç„¡æ³•é ç´„éå»çš„æ™‚é–“æ®µ', 'error');
            return;
        }

        const slotDate = new Date(date);
        if (!this.isWithinTwoMonths(slotDate)) {
            this.showMessage('åªèƒ½é ç´„å…©å€‹æœˆå…§çš„æ™‚æ®µ', 'error');
            return;
        }

        this.selectedDate = date;
        this.selectedTime = time;
        
        const modal = document.getElementById('bookingModal');
        const details = document.getElementById('bookingDetails');
        
        details.innerHTML = `
            <p><strong>æ—¥æœŸï¼š</strong>${date}</p>
            <p><strong>æ™‚é–“ï¼š</strong>${time}</p>
        `;
        
        document.getElementById('bookingName').value = this.currentUser.realName || '';
        document.getElementById('bookingNotes').value = '';
        
        modal.style.display = 'flex';
    }

    closeModal() {
        document.getElementById('bookingModal').style.display = 'none';
    }

    // ç®¡ç†å“¡ç›¸é—œæ–¹æ³•
    async renderAdminPanel() {
        if (!this.currentUser || !this.cloudStorage.isAdmin(this.currentUser)) return;
        
        const users = await this.cloudStorage.getAllUsers();
        const bookings = await this.cloudStorage.getAllBookings();
        const pendingUsers = await this.cloudStorage.getPendingUsers();
        const today = new Date().toISOString().split('T')[0];
        const todayBookings = bookings.filter(booking => booking.date === today && booking.status !== 'cancelled');

        document.getElementById('totalUsers').textContent = users.length;
        document.getElementById('pendingUsers').textContent = pendingUsers.length;
        document.getElementById('totalBookings').textContent = bookings.filter(b => b.status !== 'cancelled').length;
        document.getElementById('todayBookings').textContent = todayBookings.length;
        
        this.renderPendingUsers(pendingUsers);
        this.renderTodayBookings(todayBookings);
        this.renderAllBookings(bookings);
        this.renderAllUsers(users);
    }

    renderPendingUsers(users) {
        const container = document.getElementById('pendingUsersList');
        container.innerHTML = '';
        
        if (users.length === 0) {
            container.innerHTML = '<p>ç„¡å¾…å¯©æ ¸ç”¨æˆ¶</p>';
            return;
        }
        
        users.forEach(user => {
            const userEl = document.createElement('div');
            userEl.className = 'user-item';
            userEl.innerHTML = `
                <div class="user-info">
                    <div><strong>å§“åï¼š</strong>${user.real_name}</div>
                    <div><strong>å­¸è™Ÿï¼š</strong>${user.student_id}</div>
                    <div><strong>é›»å­éƒµä»¶ï¼š</strong>${user.email}</div>
                    <div><strong>é›»è©±ï¼š</strong>${user.phone}</div>
                </div>
                <div class="user-actions">
                    <button class="btn btn-success btn-sm" onclick="app.approveUser('${user.email}')">æ ¸å‡†</button>
                    <button class="btn btn-danger btn-sm" onclick="app.rejectUser('${user.email}')">æ‹’çµ•</button>
                </div>
            `;
            container.appendChild(userEl);
        });
    }

    renderTodayBookings(bookings) {
        const container = document.getElementById('todayBookingsList');
        container.innerHTML = '';
        
        if (bookings.length === 0) {
            container.innerHTML = '<p>ä»Šæ—¥ç„¡é ç´„</p>';
            return;
        }
        
        bookings.forEach(booking => {
            const bookingEl = document.createElement('div');
            bookingEl.className = 'booking-item';
            bookingEl.innerHTML = `
                <div class="booking-info">
                    <div><strong>åç¨±ï¼š</strong>${booking.name}</div>
                    <div><strong>é ç´„äººï¼š</strong>${booking.real_name} (${booking.user_email})</div>
                    <div><strong>æ™‚é–“ï¼š</strong>${booking.time}</div>
                    <div><strong>é¡å‹ï¼š</strong>${this.getTypeText(booking.type)}</div>
                    <div><strong>å‚™è¨»ï¼š</strong>${booking.notes || 'ç„¡'}</div>
                </div>
            `;
            container.appendChild(bookingEl);
        });
    }

    renderAllBookings(bookings) {
        const container = document.getElementById('allBookingsList');
        container.innerHTML = '';
        
        const activeBookings = bookings.filter(b => b.status !== 'cancelled');
        
        if (activeBookings.length === 0) {
            container.innerHTML = '<p>ç„¡é ç´„è¨˜éŒ„</p>';
            return;
        }
        
        activeBookings.forEach(booking => {
            const bookingEl = document.createElement('div');
            bookingEl.className = 'booking-item';
            bookingEl.innerHTML = `
                <div class="booking-info">
                    <div><strong>åç¨±ï¼š</strong>${booking.name}</div>
                    <div><strong>é ç´„äººï¼š</strong>${booking.real_name} (${booking.user_email})</div>
                    <div><strong>æ—¥æœŸï¼š</strong>${booking.date}</div>
                    <div><strong>æ™‚é–“ï¼š</strong>${booking.time}</div>
                    <div><strong>é¡å‹ï¼š</strong>${this.getTypeText(booking.type)}</div>
                    <div><strong>ç‹€æ…‹ï¼š</strong>${booking.status}</div>
                </div>
                <div class="booking-actions">
                    <button class="btn btn-danger btn-sm" onclick="app.deleteBooking('${booking.id}')">å–æ¶ˆé ç´„</button>
                </div>
            `;
            container.appendChild(bookingEl);
        });
    }

    renderAllUsers(users) {
        const container = document.getElementById('allUsersList');
        container.innerHTML = '';
        
        users.forEach(user => {
            const userEl = document.createElement('div');
            userEl.className = 'user-item';
            userEl.innerHTML = `
                <div class="user-info">
                    <div><strong>å§“åï¼š</strong>${user.real_name}</div>
                    <div><strong>å­¸è™Ÿï¼š</strong>${user.student_id}</div>
                    <div><strong>é›»å­éƒµä»¶ï¼š</strong>${user.email}</div>
                    <div><strong>ç‹€æ…‹ï¼š</strong><span class="status-${user.status}">${user.status}</span></div>
                </div>
            `;
            container.appendChild(userEl);
        });
    }

// ä¿®æ”¹ approveUser æ–¹æ³•ï¼ŒåŠ å…¥éƒµä»¶é€šçŸ¥
async approveUser(email) {
    try {
        // å…ˆç²å–ç”¨æˆ¶è³‡æ–™
        const users = await this.cloudStorage.getAllUsers();
        const userToApprove = users.find(user => user.email === email);
        
        if (!userToApprove) {
            this.showMessage('æ‰¾ä¸åˆ°è©²ç”¨æˆ¶', 'error');
            return;
        }

        // æ ¸å‡†ç”¨æˆ¶
        await this.cloudStorage.approveUser(email);
        
        // ç™¼é€å¯©æ ¸é€šéé€šçŸ¥éƒµä»¶
        try {
            await this.sendApprovalNotification(email, userToApprove);
            this.showMessage('ç”¨æˆ¶å·²æ ¸å‡†ï¼Œä¸¦å·²ç™¼é€é€šçŸ¥éƒµä»¶', 'success');
        } catch (mailError) {
            console.error('éƒµä»¶ç™¼é€å¤±æ•—ï¼Œä½†ç”¨æˆ¶å·²æ ¸å‡†:', mailError);
            this.showMessage('ç”¨æˆ¶å·²æ ¸å‡†ï¼Œä½†é€šçŸ¥éƒµä»¶ç™¼é€å¤±æ•—', 'warning');
        }
        
        // é‡æ–°æ¸²æŸ“ç®¡ç†å“¡é¢æ¿
        await this.renderAdminPanel();
        
    } catch (error) {
        this.showMessage('æ ¸å‡†å¤±æ•—ï¼š' + error.message, 'error');
    }
}

// ä¿®æ”¹ rejectUser æ–¹æ³•ï¼ˆå¯é¸ï¼‰
async rejectUser(email) {
    try {
        await this.cloudStorage.rejectUser(email);
        
        // é€™è£¡å¯ä»¥æ·»åŠ æ‹’çµ•é€šçŸ¥çš„ç™¼é€é‚è¼¯
        // await this.sendRejectionNotification(email);
        
        this.showMessage('ç”¨æˆ¶å·²æ‹’çµ•', 'success');
        this.renderAdminPanel();
    } catch (error) {
        this.showMessage('æ‹’çµ•å¤±æ•—ï¼š' + error.message, 'error');
    }
}

    async deleteBooking(bookingId) {
        try {
            await this.cloudStorage.cancelBooking(bookingId);
            this.showMessage('é ç´„å·²å–æ¶ˆ', 'success');
            this.renderAdminPanel();
            if (this.currentView === 'calendar') {
                this.renderTimelineCalendar();
            }
        } catch (error) {
            this.showMessage('å–æ¶ˆé ç´„å¤±æ•—ï¼š' + error.message, 'error');
        }
    }
}

// å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
const app = new BandRoomApp();
    </script>
</body>
</html>